<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/alex-next/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/alex-next/images/favicon.ico?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/alex-next/images/favicon.ico?v=7.4.0">
  <link rel="mask-icon" href="/alex-next/images/logo.svg?v=7.4.0" color="#222">
  <link rel="alternate" href="/alex-next/atom.xml" title="alex的博客 - github.com" type="application/atom+xml">

<link rel="stylesheet" href="/alex-next/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/alex-next/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/alex-next/',
    scheme: 'Pisces',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: true,
    pangu: true,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="基础篇项目背景微服务架构图  分布式基础概念微服务集群-分布式-节点远程调用负载均衡服务注册/发现&amp;amp;注册中心配置中心服务熔断&amp;amp;降级API网关l环境搭建1.搭建linux虚拟机vagrant安装 网络设置-不要端口转发 端口转发示意图：   自己使用的virtualbox安装 sudo -i进入root权限  安装过程中页面小：使用 sudo xrandr和xrandr -s 192">
<meta name="keywords" content="项目">
<meta property="og:type" content="article">
<meta property="og:title" content="商城项目记录">
<meta property="og:url" content="https://alexander-wd.github.io/2022/10/27/javaEE/商城项目记录/index.html">
<meta property="og:site_name" content="alex的博客 - github.com">
<meta property="og:description" content="基础篇项目背景微服务架构图  分布式基础概念微服务集群-分布式-节点远程调用负载均衡服务注册/发现&amp;amp;注册中心配置中心服务熔断&amp;amp;降级API网关l环境搭建1.搭建linux虚拟机vagrant安装 网络设置-不要端口转发 端口转发示意图：   自己使用的virtualbox安装 sudo -i进入root权限  安装过程中页面小：使用 sudo xrandr和xrandr -s 192">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2023-02-13T10:37:43.989Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="商城项目记录">
<meta name="twitter:description" content="基础篇项目背景微服务架构图  分布式基础概念微服务集群-分布式-节点远程调用负载均衡服务注册/发现&amp;amp;注册中心配置中心服务熔断&amp;amp;降级API网关l环境搭建1.搭建linux虚拟机vagrant安装 网络设置-不要端口转发 端口转发示意图：   自己使用的virtualbox安装 sudo -i进入root权限  安装过程中页面小：使用 sudo xrandr和xrandr -s 192">
  <link rel="canonical" href="https://alexander-wd.github.io/2022/10/27/javaEE/商城项目记录/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>商城项目记录 | alex的博客 - github.com</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/alex-next/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">alex的博客 - github.com</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/alex-next/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/alex-next/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>标签</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/alex-next/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/alex-next/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/alexander-wd" class="github-corner" title="alex GitHub" aria-label="alex GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="https://alexander-wd.github.io/alex-next/2022/10/27/javaEE/商城项目记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="alex">
      <meta itemprop="description" content="时光静好,与君语;细水流年,与君同;繁华落尽,与君老.">
      <meta itemprop="image" content="/alex-next/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="alex的博客 - github.com">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">商城项目记录

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2022-10-27 16:10:20" itemprop="dateCreated datePublished" datetime="2022-10-27T16:10:20+08:00">2022-10-27</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-13 18:37:43" itemprop="dateModified" datetime="2023-02-13T18:37:43+08:00">2023-02-13</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/alex-next/categories/JavaEE/" itemprop="url" rel="index"><span itemprop="name">JavaEE</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="基础篇"><a href="#基础篇" class="headerlink" title="基础篇"></a>基础篇</h2><h3 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h3><p>微服务架构图</p>
<p><img alt="谷粒商城-微服务架构图" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230108213105.jpg"></p>
<h3 id="分布式基础概念"><a href="#分布式基础概念" class="headerlink" title="分布式基础概念"></a>分布式基础概念</h3><h4 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h4><h4 id="集群-分布式-节点"><a href="#集群-分布式-节点" class="headerlink" title="集群-分布式-节点"></a>集群-分布式-节点</h4><h4 id="远程调用"><a href="#远程调用" class="headerlink" title="远程调用"></a>远程调用</h4><h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><h4 id="服务注册-发现-amp-注册中心"><a href="#服务注册-发现-amp-注册中心" class="headerlink" title="服务注册/发现&amp;注册中心"></a>服务注册/发现&amp;注册中心</h4><h4 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h4><h4 id="服务熔断-amp-降级"><a href="#服务熔断-amp-降级" class="headerlink" title="服务熔断&amp;降级"></a>服务熔断&amp;降级</h4><h4 id="API网关l"><a href="#API网关l" class="headerlink" title="API网关l"></a>API网关l</h4><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><h4 id="1-搭建linux虚拟机"><a href="#1-搭建linux虚拟机" class="headerlink" title="1.搭建linux虚拟机"></a>1.搭建linux虚拟机</h4><h5 id="vagrant安装"><a href="#vagrant安装" class="headerlink" title="vagrant安装"></a>vagrant安装</h5><blockquote>
<p>网络设置-不要端口转发</p>
<p>端口转发示意图：</p>
<p><img alt data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230108213058.png"></p>
</blockquote>
<h5 id="自己使用的virtualbox安装"><a href="#自己使用的virtualbox安装" class="headerlink" title="自己使用的virtualbox安装"></a>自己使用的virtualbox安装</h5><blockquote>
<p>sudo -i进入root权限</p>
</blockquote>
<p>安装过程中页面小：使用</p>
<p>sudo xrandr和xrandr -s 1920x1080进行设置</p>
<p>1.安装成功后记得找上面设备-&gt;安装增强功能</p>
<p>2.安装成功后使用xshell连接ubuntu</p>
<p>2.1 安装软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install openssh-server</span><br><span class="line">#开启防火墙端口</span><br><span class="line">firewall-cmd --zone=public --add-port=22/tcp --permanent</span><br></pre></td></tr></table></figure>
<p>2.2 设置网卡</p>
<p>解释：</p>
<p>NAT模式是最简单的实现虚拟机上网的方式，你可以这样理解：Vhost访问网络的所有数据都是由主机提供的，vhost并不真实存在于网络中，主机与网络中的任何机器都不能查看和访问到Vhost的存在。<br>虚拟机与主机关系：<br>只能单向访问，虚拟机可以通过网络访问到主机，主机无法通过网络访问到虚拟机。</p>
<p><img alt="img" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230115231221.png"></p>
<p><img alt="12" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230115231222.png"></p>
<p>2.3 然后使用ifconfig查看ubuntu的ip地址，然后使用xshell连接</p>
<h5 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h5><blockquote>
<p><a href="https://blog.csdn.net/ningmengzhihe/article/details/127295333" target="_blank" rel="noopener">https://blog.csdn.net/ningmengzhihe/article/details/127295333</a></p>
</blockquote>
<h4 id="2-安装docker"><a href="#2-安装docker" class="headerlink" title="2.安装docker"></a>2.安装docker</h4><blockquote>
<p>docker镜像去dockerhub</p>
<p>docker本身去docker官网找文档</p>
</blockquote>
<h4 id="3-docker安装mysql"><a href="#3-docker安装mysql" class="headerlink" title="3.docker安装mysql"></a>3.docker安装mysql</h4><blockquote>
<p>挂载文件，方便修改文件</p>
<p>开机自启动：sudo docker update mysql —restart=always</p>
</blockquote>
<p>==mysql(5.7)闪退解决方案，但是下载mysql5.6没有问题==</p>
<p><a href="https://www.zhangshengrong.com/p/QrXebV9p1d/" target="_blank" rel="noopener">https://www.zhangshengrong.com/p/QrXebV9p1d/</a></p>
<p>镜像中apt-update太慢(使用cat &gt;&gt; 加入)</p>
<p><a href="https://blog.csdn.net/yjk13703623757/article/details/113194891" target="_blank" rel="noopener">https://blog.csdn.net/yjk13703623757/article/details/113194891</a></p>
<blockquote>
<p>创建容器并启动</p>
<p>docker run -p 3306:3306 —name mysql \</p>
<p>-v /mydata/mysql/log:/var/log/mysql \</p>
<p>-v /mydata/mysql/data:/var/lib/mysql \</p>
<p>-v /mydata/mysql/conf:/etc/mysql \</p>
<p>-e MYSQL_ROOT_PASSWORD=root \</p>
<p>-d mysql:5.7</p>
</blockquote>
<h4 id="4-docker安装redis"><a href="#4-docker安装redis" class="headerlink" title="4.docker安装redis"></a>4.docker安装redis</h4><blockquote>
<p>开启持久化 appendonly yes</p>
<p>开机自启动：sudo docker update redis —restart=always</p>
</blockquote>
<h4 id="5-安装开发环境"><a href="#5-安装开发环境" class="headerlink" title="5.安装开发环境"></a>5.安装开发环境</h4><p>git </p>
<blockquote>
<p>配置ssh免密登陆</p>
</blockquote>
<h4 id="6-逆向生成代码"><a href="#6-逆向生成代码" class="headerlink" title="6.逆向生成代码"></a>6.逆向生成代码</h4><p>使用人人开源生成器生成</p>
<h3 id="前端开发基础知识"><a href="#前端开发基础知识" class="headerlink" title="前端开发基础知识"></a>前端开发基础知识</h3><blockquote>
<p>==请参考课件==</p>
</blockquote>
<p>前后端技术类比图</p>
<p><img alt data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230108213052.png"></p>
<h4 id="ES6"><a href="#ES6" class="headerlink" title="ES6"></a>ES6</h4><blockquote>
<p>js是它的一个实现</p>
</blockquote>
<h5 id="map-reduce"><a href="#map-reduce" class="headerlink" title="==map== ==reduce=="></a>==map== ==reduce==</h5><h5 id="promise"><a href="#promise" class="headerlink" title="==promise=="></a>==promise==</h5><p>&gt;</p>
<blockquote>
<p>解决异步嵌套</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">&gt;     $.ajax(&#123;</span><br><span class="line">&gt;         url: <span class="string">"mock/user.json"</span>,</span><br><span class="line">&gt;         success(data) &#123;</span><br><span class="line">&gt;             <span class="built_in">console</span>.log(<span class="string">"查询用户："</span>, data);</span><br><span class="line">&gt;             resolve(data.id);</span><br><span class="line">&gt;         &#125;,</span><br><span class="line">&gt;         error(error) &#123;</span><br><span class="line">&gt;             <span class="built_in">console</span>.log(<span class="string">"出现异常了："</span> + error);</span><br><span class="line">&gt;         &#125;</span><br><span class="line">&gt;     &#125;);</span><br><span class="line">&gt; &#125;).then(<span class="function">(<span class="params">userId</span>) =&gt;</span> &#123;</span><br><span class="line">&gt;     <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">&gt;         $.ajax(&#123;</span><br><span class="line">&gt;             url: <span class="string">`mock/user_corse_<span class="subst">$&#123;userId&#125;</span>.json`</span>,</span><br><span class="line">&gt;             success(data) &#123;</span><br><span class="line">&gt;                 <span class="built_in">console</span>.log(<span class="string">"查询到课程："</span>, data);</span><br><span class="line">&gt;                 resolve(data.id);</span><br><span class="line">&gt;             &#125;,</span><br><span class="line">&gt;             error(error) &#123;</span><br><span class="line">&gt;             	<span class="built_in">console</span>.log(<span class="string">"出现异常了："</span> + error);</span><br><span class="line">&gt;             &#125;</span><br><span class="line">&gt;         &#125;);</span><br><span class="line">&gt;     &#125;);</span><br><span class="line">&gt; &#125;).then(<span class="function">(<span class="params">corseId</span>) =&gt;</span> &#123;</span><br><span class="line">&gt;     <span class="built_in">console</span>.log(corseId);</span><br><span class="line">&gt;     $.ajax(&#123;</span><br><span class="line">&gt;         url: <span class="string">`mock/corse_score_<span class="subst">$&#123;corseId&#125;</span>.json`</span>,</span><br><span class="line">&gt;         success(data) &#123;</span><br><span class="line">&gt;             <span class="built_in">console</span>.log(<span class="string">"查询到分数："</span>, data);</span><br><span class="line">&gt;         &#125;,</span><br><span class="line">&gt;         error(error) &#123;</span><br><span class="line">&gt;             <span class="built_in">console</span>.log(<span class="string">"出现异常了："</span> + error);</span><br><span class="line">&gt;         &#125;</span><br><span class="line">&gt;     &#125;);</span><br><span class="line">&gt; &#125;);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>优化：将promise封装为一个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">let</span> <span class="keyword">get</span> = function (url, data) &#123; <span class="comment">// 实际开发中会单独放到 common.js 中</span></span><br><span class="line">&gt;     <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">&gt;         $.ajax(&#123;</span><br><span class="line">&gt;             url: url,</span><br><span class="line">&gt;             type: <span class="string">"GET"</span>,</span><br><span class="line">&gt;             data: data,</span><br><span class="line">&gt;             success(result) &#123;</span><br><span class="line">&gt;             	resolve(result);</span><br><span class="line">&gt;             &#125;,</span><br><span class="line">&gt;             error(error) &#123;</span><br><span class="line">&gt;             	reject(error);</span><br><span class="line">&gt;             &#125;</span><br><span class="line">&gt;         &#125;);</span><br><span class="line">&gt;     &#125;)</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; <span class="keyword">get</span>("mock/user.json").then((result) =&gt; &#123;</span><br><span class="line">&gt;     <span class="built_in">console</span>.log(<span class="string">"查询用户："</span>, result);</span><br><span class="line">&gt;     <span class="keyword">return</span> <span class="keyword">get</span>(`mock/user_corse_$&#123;result.id&#125;.json<span class="string">`);</span></span><br><span class="line"><span class="string">&gt; &#125;).then((result) =&gt; &#123;</span></span><br><span class="line"><span class="string">&gt;     console.log("查询到课程：", result);</span></span><br><span class="line"><span class="string">&gt;     return get(`</span>mock/corse_score_$&#123;result.id&#125;.json<span class="string">`)</span></span><br><span class="line"><span class="string">&gt; &#125;).then((result) =&gt; &#123;</span></span><br><span class="line"><span class="string">&gt; 	console.log("查询到分数：", result);</span></span><br><span class="line"><span class="string">&gt; &#125;).catch(() =&gt; &#123;</span></span><br><span class="line"><span class="string">&gt; 	console.log("出现异常了：" + error);</span></span><br><span class="line"><span class="string">&gt; &#125;);</span></span><br><span class="line"><span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h5><blockquote>
<p>是vue模块化的基础</p>
<p>导出</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> util = &#123;</span><br><span class="line">    sum(a,b)&#123;</span><br><span class="line">    	<span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> name = <span class="string">"jack"</span></span><br><span class="line"><span class="keyword">var</span> age = <span class="number">21</span></span><br><span class="line"><span class="keyword">export</span> &#123;util,name,age&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以自己起名</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span><br><span class="line">    sum(a,b)&#123;</span><br><span class="line">    	<span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>导入</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> util <span class="keyword">from</span> <span class="string">'hello.js'</span></span><br><span class="line"><span class="keyword">import</span> &#123;age,name&#125; <span class="keyword">from</span> <span class="string">'user.js'</span></span><br></pre></td></tr></table></figure>
<h5 id="json-的key和value相同可以省略key"><a href="#json-的key和value相同可以省略key" class="headerlink" title="json 的key和value相同可以省略key"></a>json 的key和value相同可以省略key</h5><h4 id="Node-js"><a href="#Node-js" class="headerlink" title="Node.js"></a>Node.js</h4><p>主要用到其中的npm，相当于java的maven</p>
<p>每次开启vue项目使用npm install根据package.json安装依赖包</p>
<h4 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h4><h5 id="初步使用"><a href="#初步使用" class="headerlink" title="初步使用"></a>初步使用</h5><blockquote>
<p>1.npm init -y生成package.json</p>
<p>2.npm install vue</p>
<p>调试工具vue-devtools</p>
</blockquote>
<h5 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h5><blockquote>
<p>数据与页面元素绑定上了，只需要把关注点放到model上，不需要繁琐的操作DOM</p>
</blockquote>
<h5 id="指令总结"><a href="#指令总结" class="headerlink" title="指令总结"></a>指令总结</h5><blockquote>
<p><strong>v-text、v-html和双大括号:给标签内容绑定值          双大括号就是直接从data中取出数据</strong></p>
<p><strong>v-bind:给标签属性绑定值</strong>  可以缩写，只留冒号</p>
<p><strong>以上都是单向绑定数据(页面值变了，data中不会变)</strong></p>
<p><strong>v-model可以实现双向绑定(页面值变了，data中会变)</strong></p>
<p><strong>v-model可以绑定的元素有input、select、textarea、checkbox、radio、components(vue组件)</strong></p>
<p><strong>v-on:给标签绑定事件</strong></p>
<p>​    事件修饰符</p>
<p>​    按键修饰符</p>
<p>​    组合按钮</p>
<p>v-for  写上:key渲染效率更高</p>
<p>v-if (直接html消失)</p>
<p>v-show(display:none)</p>
<p><strong>以上绑定的值都是从data中取出</strong></p>
<p>==最最最核心的就是data，页面的动态绑定的状态值都是在这里==</p>
</blockquote>
<h5 id="计算属性"><a href="#计算属性" class="headerlink" title="==计算属性=="></a>==计算属性==</h5><blockquote>
<p>computed：动态计算</p>
<p>应用：某个变量发生变化时，其他变量根据这个变量变化</p>
</blockquote>
<h5 id="监听器"><a href="#监听器" class="headerlink" title="==监听器=="></a>==监听器==</h5><blockquote>
<p>watch：监听某个方法的变化</p>
<p>应用：某个变量变化时，做出相应的反应(函数)</p>
</blockquote>
<h5 id="过滤器"><a href="#过滤器" class="headerlink" title="==过滤器=="></a>==过滤器==</h5><blockquote>
<p>filters：定义一些函数进行转换</p>
<p>应用：(0,1)-&gt;(男，女)</p>
<p>全局过滤器：Vue.filter({})</p>
</blockquote>
<h5 id="组件化"><a href="#组件化" class="headerlink" title="组件化"></a>组件化</h5><blockquote>
<p>复用重复的组件</p>
<p>tips</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; data()&#123;</span><br><span class="line">&gt;     <span class="keyword">return</span> &#123;</span><br><span class="line">&gt;         count:<span class="number">1</span></span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; 组件中返回了一个新对象，而不是</span><br><span class="line">&gt; data()&#123;</span><br><span class="line">&gt;     count:<span class="number">1</span></span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; 这样可以防止动一个组件，其他跟着一起动</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="父子组件传值"><a href="#父子组件传值" class="headerlink" title="==父子组件传值=="></a>==父子组件传值==</h5><blockquote>
<p>参考</p>
<p><a href="https://www.jianshu.com/p/1e91be0d280d" target="_blank" rel="noopener">https://www.jianshu.com/p/1e91be0d280d</a> 父子组件的通信</p>
<p><a href="https://www.jianshu.com/p/3ab0b823d5b0" target="_blank" rel="noopener">https://www.jianshu.com/p/3ab0b823d5b0</a> 非父子组件的通信、插槽Slot</p>
<p><a href="https://www.jianshu.com/p/7a972277dd0d" target="_blank" rel="noopener">https://www.jianshu.com/p/7a972277dd0d</a> 动态组件、异步组件、生命周期、组件的v-model、Mixin</p>
</blockquote>
<h6 id="使用了-emit向父组件中返回值"><a href="#使用了-emit向父组件中返回值" class="headerlink" title="==使用了$emit向父组件中返回值=="></a>==使用了$emit向父组件中返回值==</h6><p>父组件(brand-add-or-update.vue)：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">single-upload</span> <span class="attr">v-model</span>=<span class="string">"dataForm.logo"</span>&gt;</span><span class="tag">&lt;/<span class="name">single-upload</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>子组件(singleUpload.vue)：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">emitInput(val) &#123;</span><br><span class="line">    参考  https:<span class="comment">//www.h5w3.com/81714.html</span></span><br><span class="line">    在这里返回给父组件 </span><br><span class="line">    <span class="keyword">this</span>.$emit(<span class="string">'input'</span>, val)<span class="comment">// 触发输入行为,v-model 绑定的是 input 事件</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">handleUploadSuccess(res, file) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"上传成功..."</span>)</span><br><span class="line">        <span class="keyword">this</span>.showFileList = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.fileList.pop();</span><br><span class="line">        <span class="keyword">this</span>.fileList.push(&#123;<span class="attr">name</span>: file.name, <span class="attr">url</span>: <span class="keyword">this</span>.dataObj.host + <span class="string">'/'</span> + <span class="keyword">this</span>.dataObj.key.replace(<span class="string">"$&#123;filename&#125;"</span>,file.name)&#125;);</span><br><span class="line">        <span class="comment">// 在这里返回给父组件logo的地址</span></span><br><span class="line">        <span class="keyword">this</span>.emitInput(<span class="keyword">this</span>.fileList[<span class="number">0</span>].url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="父组件可以使用-props-把数据传给子组件"><a href="#父组件可以使用-props-把数据传给子组件" class="headerlink" title="==父组件可以使用 props 把数据传给子组件=="></a>==父组件可以使用 props 把数据传给子组件==</h6><p>父组件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//直接绑定 :title=v-bind:title</span><br><span class="line"><span class="tag">&lt;<span class="name">show-message</span> <span class="attr">:title</span>=<span class="string">"title"</span> <span class="attr">:content</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">show-message</span>&gt;</span></span><br><span class="line">//绑定对象的属性</span><br><span class="line"><span class="tag">&lt;<span class="name">show-message</span> <span class="attr">:title</span>=<span class="string">"message.title"</span> <span class="attr">:content</span>=<span class="string">"message.content"</span>&gt;</span><span class="tag">&lt;/<span class="name">show-message</span>&gt;</span></span><br><span class="line">//绑定对象，就会把对象的所有属性绑定到组件上，这种写法和上一行效果一样</span><br><span class="line"><span class="tag">&lt;<span class="name">show-message</span> <span class="attr">v-bind</span>=<span class="string">"message"</span>&gt;</span><span class="tag">&lt;/<span class="name">show-message</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//数据</span><br><span class="line">data() &#123;</span><br><span class="line">  return &#123;</span><br><span class="line">    title: "嘻嘻嘻",</span><br><span class="line">    content: "我是嘻嘻嘻嘻",</span><br><span class="line">    message: &#123;</span><br><span class="line">      title: "嘿嘿嘿",</span><br><span class="line">      content: "我是嘿嘿嘿"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>子组件  </p>
<blockquote>
<p>子组件使用props指定要什么值</p>
<p>父组件调用子组件时也要指定传什么值</p>
</blockquote>
<p><img alt="img" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230108230519"></p>
<h5 id="生命周期钩子函数"><a href="#生命周期钩子函数" class="headerlink" title="生命周期钩子函数"></a>生命周期钩子函数</h5><blockquote>
<p>Vue在生命周期的每个状态都设置了监听函数，我们可以根据业务需求在Vue的各个生命周期设置各种函数执行相应的功能 </p>
<p>有点像Spring的AOP？？</p>
</blockquote>
<h5 id="使用脚手架快速开发"><a href="#使用脚手架快速开发" class="headerlink" title="使用脚手架快速开发"></a>使用脚手架快速开发</h5><blockquote>
<p>1.<strong>npm install webpack -g</strong></p>
<p>2.<strong>npm install -g @vue/cli-init</strong></p>
<p>​    安装vue脚手架</p>
<p>3.vue init webpack appname</p>
<p>​    初始化</p>
<p>==初始化的Vue项目详解看P43==</p>
<p>@是src根目录</p>
<p>==vscode可以自定义代码模板     ctrl+shift+f快速整理==</p>
</blockquote>
<h4 id="Babel"><a href="#Babel" class="headerlink" title="Babel"></a>Babel</h4><blockquote>
<p>老浏览器不支持ES6语法，Babel可以转成它们支持的老js语法</p>
</blockquote>
<h4 id="Webpack"><a href="#Webpack" class="headerlink" title="Webpack"></a>Webpack</h4><blockquote>
<p>打包工具，gulp是同类产品</p>
</blockquote>
<h3 id="SpringCloud-amp-SpringCloud-Alibaba组件"><a href="#SpringCloud-amp-SpringCloud-Alibaba组件" class="headerlink" title="==SpringCloud &amp; SpringCloud Alibaba组件=="></a>==SpringCloud &amp; SpringCloud Alibaba组件==</h3><blockquote>
<p>==SpringCloud Alibaba组件请参考github项目==</p>
<p><strong>SpringCloud</strong> <strong>的几大痛点</strong></p>
<p>SpringCloud 部分组件停止维护和更新，给开发带来不便；</p>
<p>SpringCloud 部分环境搭建复杂，没有完善的可视化界面，我们需要大量的二次开发和定制</p>
<p>SpringCloud 配置复杂，难以上手，部分配置差别难以区分和合理应用</p>
<p><strong>SpringCloud Alibaba</strong> <strong>的优势：</strong></p>
<p>阿里使用过的组件经历了考验，性能强悍，设计合理，现在开源出来大家用</p>
<p>成套的产品搭配完善的可视化界面给开发运维带来极大的便利</p>
<p>搭建简单，学习曲线低。</p>
</blockquote>
<p><strong>结合</strong> <strong>SpringCloud Alibaba</strong> <strong>我们最终的技术搭配方案：</strong></p>
<h5 id="SpringCloud-Alibaba-Nacos：注册中心（服务发现注册）"><a href="#SpringCloud-Alibaba-Nacos：注册中心（服务发现注册）" class="headerlink" title="SpringCloud Alibaba - Nacos：注册中心（服务发现注册）"></a><strong>SpringCloud Alibaba - Nacos</strong>：注册中心（服务发现注册）</h5><blockquote>
<p>对比Eureka</p>
<p>1.先在github上下载nacos文件包</p>
<p>2.引入pom依赖</p>
<p>3.配置application.yml的nacos地址</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&gt; spring:</span></span><br><span class="line"><span class="string">&gt;   application:</span></span><br><span class="line"><span class="string">&gt;     name: gulimall-coupon</span></span><br><span class="line"><span class="string">&gt;   cloud:</span></span><br><span class="line"><span class="string">&gt;     nacos:</span></span><br><span class="line"><span class="string">&gt;       discovery:</span></span><br><span class="line"><span class="string">&gt;         server-addr: localhost:8848</span></span><br><span class="line"><span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>4.开启@EnableDiscoveryClient注解</p>
</blockquote>
<h5 id="SpringCloud-Alibaba-Nacos：配置中心-（动态配置管理）"><a href="#SpringCloud-Alibaba-Nacos：配置中心-（动态配置管理）" class="headerlink" title="==SpringCloud Alibaba - Nacos：配置中心==（动态配置管理）"></a><strong>==SpringCloud Alibaba - Nacos：配置中心==（动态配置管理）</strong></h5><h6 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h6><blockquote>
<p>1.先在github上下载nacos文件包</p>
<p>2.引入pom依赖</p>
<p>3.配置bootstrap.yml的nacos地址</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&gt; spring:</span></span><br><span class="line"><span class="string">&gt;   application:</span></span><br><span class="line"><span class="string">&gt;     name: gulimall-coupon</span></span><br><span class="line"><span class="string">&gt;   cloud:</span></span><br><span class="line"><span class="string">&gt;     nacos:</span></span><br><span class="line"><span class="string">&gt;       config:</span></span><br><span class="line"><span class="string">&gt;         server-addr: localhost:8848</span></span><br><span class="line"><span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>==4.在需要刷新属性值的类上加上@RefreshScope==+ 属性名上加@Value</p>
<p>5.在nacos界面添加配置，配置的id是springboot启动界面出现的properties名称(项目名.properties)</p>
<p>tips：优先使用配置中心的配置，再使用项目中的配置</p>
<p>==作用：可以实时，不下线应用的前提下修改application.properties配置文件中的值==</p>
</blockquote>
<h6 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h6><blockquote>
<p><strong>1.命名空间:</strong></p>
<p>配置隔离：</p>
<p>1.1默认的命名空间是public，通过命名空间区分测试、开发、生产环境</p>
<blockquote>
<p>在bootstrap中配置命名空间的空间id—namespace</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&gt; &gt; spring:</span></span><br><span class="line"><span class="string">&gt; &gt;   application:</span></span><br><span class="line"><span class="string">&gt; &gt;     name: gulimall-coupon</span></span><br><span class="line"><span class="string">&gt; &gt;   cloud:</span></span><br><span class="line"><span class="string">&gt; &gt;     nacos:</span></span><br><span class="line"><span class="string">&gt; &gt;       config:</span></span><br><span class="line"><span class="string">&gt; &gt;         server-addr: localhost:8848</span></span><br><span class="line"><span class="string">&gt; &gt;         namespace: 5f96fa79-8abf-49a7-a148-7bee7f77a575</span></span><br><span class="line"><span class="string">&gt; &gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>1.2每一个微服务相互隔离配置，每一个微服务都创建自己的命名空间</p>
<p>2.配置集：所有的配置的集合</p>
<p>3.配置集Id：类似文件名</p>
<p>​    Data ID：类似文件名</p>
<p>4.配置分组：默认所有的配置集都属于DEFAULT_GROUP</p>
<p>要指定group，在bootstrap.yml中配置group</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&gt; spring:</span></span><br><span class="line"><span class="string">&gt;   application:</span></span><br><span class="line"><span class="string">&gt;     name: gulimall-coupon</span></span><br><span class="line"><span class="string">&gt;   cloud:</span></span><br><span class="line"><span class="string">&gt;     nacos:</span></span><br><span class="line"><span class="string">&gt;       config:</span></span><br><span class="line"><span class="string">&gt;         group: 双11</span></span><br><span class="line"><span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>5.<strong>加载多配置文件</strong></p>
<p>直接在nacos中操作</p>
<p>在bootstrap.properties/bootstrap.yml添加ext-config</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.server-addr=127.0.0.1:8848</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.namespace=31098de9-fa28-41c9-b0bd-c754ce319ed4</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.ext-config[0].data-id=gulimall-datasource.yml</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string"># 是否自动刷新</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.ext-config[0].refresh=false</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.ext-config[0].group=dev</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string"></span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.ext-config[0].data-id=gulimall-mybatis.yml</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string"># 是否自动刷新</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.ext-config[0].refresh=false</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.ext-config[0].group=dev</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string"></span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.ext-config[0].data-id=gulimall-other.yml</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string"># 是否自动刷新</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.ext-config[0].refresh=false</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">spring.cloud.nacos.config.ext-config[0].group=dev</span></span><br><span class="line"><span class="attr">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>然后就可以把application.yml注释掉，直接用nacos的配置</p>
</blockquote>
<h5 id="SpringCloud-Ribbon：负载均衡"><a href="#SpringCloud-Ribbon：负载均衡" class="headerlink" title="SpringCloud - Ribbon：负载均衡"></a><strong>SpringCloud - Ribbon</strong>：负载均衡</h5><h5 id="SpringCloud-Feign：声明式-HTTP-客户端（调用远程服务）"><a href="#SpringCloud-Feign：声明式-HTTP-客户端（调用远程服务）" class="headerlink" title="SpringCloud - Feign：声明式 HTTP 客户端（调用远程服务）"></a><strong>SpringCloud - Feign</strong>：声明式 <strong>HTTP</strong> <strong>客户端（调用远程服务）</strong></h5><h5 id="SpringCloud-Alibaba-Sentinel：服务容错（限流、降级、熔断）"><a href="#SpringCloud-Alibaba-Sentinel：服务容错（限流、降级、熔断）" class="headerlink" title="SpringCloud Alibaba - Sentinel：服务容错（限流、降级、熔断）"></a><strong>SpringCloud Alibaba - Sentinel</strong>：服务容错（限流、降级、熔断）</h5><blockquote>
<p>对比Hystrix</p>
</blockquote>
<h5 id="SpringCloud-Gateway：API-网关（webflux-编程模式）"><a href="#SpringCloud-Gateway：API-网关（webflux-编程模式）" class="headerlink" title="SpringCloud - Gateway：API 网关（webflux 编程模式）"></a><strong>SpringCloud - Gateway</strong>：<strong>API </strong>网关（<strong>webflux</strong> <strong>编程模式）</strong></h5><blockquote>
<p>比zuul功能更多，取代了zuul</p>
<p>route(路由)</p>
<p>predicate(断言)</p>
<p>filter</p>
<p>通过路由经过断言和过滤器抵达请求，类似SpringMVC流程</p>
<p>1.添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt; <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>2.网关不需要数据库，添加如下配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="meta">@SpringBootApplication</span>(exclude = &#123;DataSourceAutoConfiguration.class&#125; )</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="SpringCloud-Sleuth：调用链监控"><a href="#SpringCloud-Sleuth：调用链监控" class="headerlink" title="SpringCloud - Sleuth：调用链监控"></a><strong>SpringCloud - Sleuth</strong>：调用链监控</h5><h5 id="SpringCloud-Alibaba-Seata：原Fescar，即分布式事务解决方案"><a href="#SpringCloud-Alibaba-Seata：原Fescar，即分布式事务解决方案" class="headerlink" title="SpringCloud Alibaba - Seata：原Fescar，即分布式事务解决方案"></a><strong>SpringCloud Alibaba - Seata</strong>：原Fescar<strong>，即分布式事务解决方案</strong></h5><h5 id="SpringCloud-Alibaba-OSS"><a href="#SpringCloud-Alibaba-OSS" class="headerlink" title="SpringCloud Alibaba - OSS"></a>SpringCloud Alibaba - OSS</h5><p>1.导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alicloud-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.配置yml</p>
<p>3.注入OSSClient(实际要注入的是OSS)</p>
<h3 id="后端正式开发"><a href="#后端正式开发" class="headerlink" title="后端正式开发"></a>后端正式开发</h3><h4 id="1-构建权限树"><a href="#1-构建权限树" class="headerlink" title="1.构建权限树"></a>1.构建权限树</h4><blockquote>
<p>思路，先把所有的id和entity用map存起来，再遍历</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用来存放结果</span></span><br><span class="line">List&lt;AuthPO&gt; authTree = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">// 使用map表示每一个菜单与id的对应关系</span></span><br><span class="line">Map&lt;Long,AuthPO&gt; authMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="comment">// 将菜单id与菜单对象以K-V对模式存入map</span></span><br><span class="line"><span class="keyword">for</span>(AuthPO auth: authPOList)&#123;</span><br><span class="line">    authMap.put(auth.getId(),auth);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (AuthPO auth:authPOList)&#123;</span><br><span class="line">    Long pid = auth.getAuthParentId();</span><br><span class="line">    <span class="keyword">if</span>(Objects.equals(pid,<span class="number">0L</span>))&#123;</span><br><span class="line">        authTree.add(auth);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    AuthPO father = authMap.get(pid);</span><br><span class="line">    father.getChildren().add(auth);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-gateway配置路由-作用-前端项目不用再一个一个改请求地址"><a href="#2-gateway配置路由-作用-前端项目不用再一个一个改请求地址" class="headerlink" title="2.gateway配置路由(作用:前端项目不用再一个一个改请求地址)"></a>2.gateway配置路由(作用:前端项目不用再一个一个改请求地址)</h4><blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&gt; spring:</span></span><br><span class="line"><span class="string">&gt;   cloud:</span></span><br><span class="line"><span class="string">&gt;     gateway:</span></span><br><span class="line"><span class="string">&gt;       routes:</span></span><br><span class="line"><span class="string">&gt;         - id: admin_route</span></span><br><span class="line"><span class="string">&gt;           # lb表示负载均衡(loadbalance),renren-fast是微服务名称</span></span><br><span class="line"><span class="string">&gt;           uri: lb://renren-fast</span></span><br><span class="line"><span class="string">&gt;           predicates:</span></span><br><span class="line"><span class="string">&gt;           	********项目中这个路由最好写到最后，最后才生效******</span></span><br><span class="line"><span class="string">&gt;             - Path=/api/**</span></span><br><span class="line"><span class="string">&gt;           filters:</span></span><br><span class="line"><span class="string">&gt;             - RewritePath=/api/(?&lt;segment&gt;/?.*), /renren-fast/$\&#123;segment&#125;</span></span><br><span class="line"><span class="string">&gt;             </span></span><br><span class="line"><span class="string">&gt; 前端请求：localhost:88/api/captcha.jpg</span></span><br><span class="line"><span class="string">&gt; 转到后端请求会重新拼接上来：localhost:8080/api/captcha.jpg</span></span><br><span class="line"><span class="string">&gt; 所以要用- RewritePath=/api/(?&lt;segment&gt;/?.*), /renren-fast/$\&#123;segment&#125;</span></span><br><span class="line"><span class="string">&gt; 效果就是把api替换为renren-fast即localhost:8080/api/captcha.jpg-&gt;localhost:8080/renren-fast/captcha.jpg</span></span><br><span class="line"><span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="3-跨域-amp-CORS同源策略"><a href="#3-跨域-amp-CORS同源策略" class="headerlink" title="==3.跨域&amp;CORS同源策略=="></a>==3.跨域&amp;CORS同源策略==</h4><blockquote>
<p>localhost:8080和localhost:88就是非同源，协议、ip和端口号一致才叫同源(域名和域名对应ip都不行)，这就不符合CORS同源策略</p>
<p><img alt="5" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230108213019.png"></p>
<p>==跨域流程参考课件图==</p>
<p>非简单请求(json数据不是)都会先发送预检请求，成功后，才发送真实请求</p>
</blockquote>
<p><strong>解决方案</strong></p>
<p>1.使用nginx部署为统一域(有图)</p>
<p>2.给预检请求配置，此次请求能跨域</p>
<blockquote>
<p>不止这一种方式</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GulimallCorsConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsWebFilter <span class="title">corsWebFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line"></span><br><span class="line">        CorsConfiguration corsConfiguration = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、配置跨域</span></span><br><span class="line">        corsConfiguration.addAllowedHeader(<span class="string">"*"</span>);</span><br><span class="line">        corsConfiguration.addAllowedMethod(<span class="string">"*"</span>);</span><br><span class="line">        corsConfiguration.addAllowedOrigin(<span class="string">"*"</span>);</span><br><span class="line">        <span class="comment">// 是否允许携带cookie</span></span><br><span class="line">        corsConfiguration.setAllowCredentials(<span class="keyword">true</span>);</span><br><span class="line">		<span class="comment">// 任意路径都需要跨域配置</span></span><br><span class="line">        source.registerCorsConfiguration(<span class="string">"/**"</span>,corsConfiguration);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CorsWebFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-对象存储"><a href="#4-对象存储" class="headerlink" title="==4.对象存储=="></a>==4.对象存储==</h4><p><img alt="6" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230108212958.png"></p>
<p>分布式项目一定要有一个专门存储图片、文件等对象的服务</p>
<p>对象存储上传方式(参考ppt图)</p>
<blockquote>
<p>服务器签名后直传，文件不经过服务器，只是从服务器拿一个签名</p>
</blockquote>
<p>步骤：</p>
<p>1.导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alicloud-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.配置yml</p>
<p>3.注入OSSClient(实际要注入的是OSS)</p>
<p>==4.请求/oss/policy获取签名==</p>
<p>==5.因为是浏览器直接向OSS传输文件，所以还存在跨域问题，要在阿里云OSS配置跨域==</p>
<p><img alt="7" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230108212933.png"></p>
<p>6.如果上传成功后，不能通过直链访问，还要配置bucket的读写权限</p>
<p><img alt="9" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230112140644.png"></p>
<h4 id="5-校验配置"><a href="#5-校验配置" class="headerlink" title="5.校验配置"></a>5.校验配置</h4><h5 id="5-1-可以紧跟-Valid后的bean声明BindingResult获得校验结果"><a href="#5-1-可以紧跟-Valid后的bean声明BindingResult获得校验结果" class="headerlink" title="5.1 可以紧跟@Valid后的bean声明BindingResult获得校验结果"></a>5.1 可以紧跟@Valid后的bean声明BindingResult获得校验结果</h5><p>这边引用的是注册功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/register"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">register</span><span class="params">(@Valid UserRegisterVo vos, BindingResult result,</span></span></span><br><span class="line"><span class="function"><span class="params">                       RedirectAttributes attributes)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如果有错误回到注册页面</span></span><br><span class="line">    <span class="keyword">if</span> (result.hasErrors()) &#123;</span><br><span class="line">        Map&lt;String, String&gt; errors = result.getFieldErrors().stream().collect(Collectors.toMap(FieldError::getField, FieldError::getDefaultMessage));</span><br><span class="line">        attributes.addFlashAttribute(<span class="string">"errors"</span>,errors);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//效验出错回到注册页面</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:http://auth.gulimall.com/reg.html"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-2-分组校验"><a href="#5-2-分组校验" class="headerlink" title="5.2 分组校验"></a>5.2 分组校验</h5><p>定义空的interface，配置校验时，指定该分组</p>
<h5 id="5-3-自定义校验"><a href="#5-3-自定义校验" class="headerlink" title="5.3 自定义校验"></a>5.3 自定义校验</h5><p>编写自定义Annotation和Validator，编写ValidationMessages.properties文件</p>
<p><strong>下面的例子就是要满足取得值在vals内</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = &#123; ListValueConstraintValidator.class &#125;)<span class="comment">// 可以指定多个校验器</span></span><br><span class="line"><span class="meta">@Target</span>(&#123; METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE &#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ListValue &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "</span>&#123;com.atguigu.common.valid.ListValue.message&#125;<span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;?&gt;[] groups() default &#123; &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;? extends Payload&gt;[] payload() default &#123; &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    int[] vals() default &#123; &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListValueConstraintValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">ListValue</span>,<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> constraintAnnotation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ListValue constraintAnnotation)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] vals = constraintAnnotation.vals();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> val : vals) &#123;</span><br><span class="line">            set.add(val);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否效验成功</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 需要效验的值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Integer value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否有包含的值</span></span><br><span class="line">        <span class="keyword">boolean</span> contains = set.contains(value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> contains;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6-日志"><a href="#6-日志" class="headerlink" title="6.日志"></a>6.日志</h4><p>直接使用@Slf4j+log</p>
<h4 id="7-推荐不要使用关联查询，把sql语句拆成多句"><a href="#7-推荐不要使用关联查询，把sql语句拆成多句" class="headerlink" title="7.推荐不要使用关联查询，把sql语句拆成多句"></a>7.推荐不要使用关联查询，把sql语句拆成多句</h4><h4 id="8-for和foreach的区别"><a href="#8-for和foreach的区别" class="headerlink" title="8.for和foreach的区别"></a>8.for和foreach的区别</h4><p><a href="https://blog.csdn.net/cpcpcp123/article/details/125410074" target="_blank" rel="noopener">参考</a></p>
<h4 id="9-feign细节"><a href="#9-feign细节" class="headerlink" title="==9.feign细节=="></a>==9.feign细节==</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">feign流程:</span><br><span class="line">1、CouponFeignService.saveSpuBounds(spuBoundTo);</span><br><span class="line">*      1）、@RequestBody将这个对象转为json。</span><br><span class="line">*      2）、找到gulimall-coupon服务，给/coupon/spubounds/save发送请求。</span><br><span class="line">*          将上一步转的json放在请求体位置，发送请求；</span><br><span class="line">*      3）、对方服务收到请求。请求体里有json数据。</span><br><span class="line">*          (@RequestBody SpuBoundsEntity spuBounds)；将请求体的json转为SpuBoundsEntity；</span><br><span class="line">feign细节:只要json数据模型是兼容的。双方服务无需使用同一个to</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1)、让所有请求过网关；</span><br><span class="line">*          1、@FeignClient(&quot;gulimall-gateway&quot;)：给gulimall-gateway所在的机器发请求</span><br><span class="line">*          2、/api/product/skuinfo/info/&#123;skuId&#125;</span><br><span class="line">2）、直接让后台指定服务处理</span><br><span class="line">*          1、@FeignClient(&quot;gulimall-product&quot;)</span><br><span class="line">*          2、/product/skuinfo/info/&#123;skuId&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10-SPU和SKU"><a href="#10-SPU和SKU" class="headerlink" title="10.SPU和SKU"></a>10.SPU和SKU</h4><p>SPU表示通用的一类商品，SKU表示具体的某个型号某个参数的商品</p>
<h3 id="前端项目开发"><a href="#前端项目开发" class="headerlink" title="前端项目开发"></a>前端项目开发</h3><blockquote>
<p>入门案例先参考category.vue就行</p>
</blockquote>
<h4 id="1-index-js中配置请求路径"><a href="#1-index-js中配置请求路径" class="headerlink" title="1.index.js中配置请求路径"></a>1.index.js中配置请求路径</h4><blockquote>
<p>localhost:88  统一从网关获取访问路径，</p>
<p>这样多个微服务地址，不用改来改去</p>
<p>配合后端第2条看</p>
</blockquote>
<h4 id="2-data-解构数据"><a href="#2-data-解构数据" class="headerlink" title="2.{data}解构数据"></a>2.{data}解构数据</h4><p>原始的data传到前端是这样的</p>
<p><img alt="10" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230112162643.png"></p>
<p>{data}解构之后才是后端真正传的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">getMenus() &#123;</span><br><span class="line">    <span class="keyword">this</span>.$http(&#123;</span><br><span class="line">        url: <span class="keyword">this</span>.$http.adornUrl(<span class="string">"/product/category/list"</span>),</span><br><span class="line">        method: <span class="string">"get"</span></span><br><span class="line">    &#125;).then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"成功获取到菜单数据..."</span>, data.page);</span><br><span class="line">        <span class="keyword">this</span>.menus = data.page;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br><span class="line">因为这边要得数据是数组类型，而我们的数据是</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"msg"</span>: <span class="string">"success"</span>,</span><br><span class="line">  <span class="string">"code"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">"page"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"图书、音像、电子书刊"</span>,</span><br><span class="line">      <span class="string">"parentId"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="string">"status"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="string">"sort"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="string">"icon"</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">"unit"</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">"children"</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">这样的对象类型</span><br><span class="line">否则就这样写</span><br><span class="line">getMenus() &#123;</span><br><span class="line">    <span class="keyword">this</span>.$http(&#123;</span><br><span class="line">        url: <span class="keyword">this</span>.$http.adornUrl(<span class="string">"/product/category/list"</span>),</span><br><span class="line">        method: <span class="string">"get"</span></span><br><span class="line">    &#125;).then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"成功获取到菜单数据..."</span>, data.data.page);</span><br><span class="line">        <span class="keyword">this</span>.menus = data.data.page;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h4 id="3-飘号-引用变量"><a href="#3-飘号-引用变量" class="headerlink" title="3.``(飘号)引用变量"></a>3.``(飘号)引用变量</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$confirm(<span class="string">`是否删除【<span class="subst">$&#123;data.name&#125;</span>】菜单?`</span>, <span class="string">"提示"</span>, &#123;</span><br><span class="line">    confirmButtonText: <span class="string">"确定"</span>,</span><br><span class="line">    cancelButtonText: <span class="string">"取消"</span>,</span><br><span class="line">    type: <span class="string">"warning"</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="4-拖拽功能有空可以看看"><a href="#4-拖拽功能有空可以看看" class="headerlink" title="4.拖拽功能有空可以看看"></a>4.拖拽功能有空可以看看</h4><h4 id="5-this-refs-menuTree"><a href="#5-this-refs-menuTree" class="headerlink" title="==5.this.$refs.menuTree=="></a>==5.this.$refs.menuTree==</h4><blockquote>
<p>在category.vue中</p>
<p>$refs表示从template节点中取，menuTree是vue的template其中一个节点取得名字</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="tag">&lt;<span class="name">el-tree</span> <span class="attr">:data</span>=<span class="string">"menus"</span> <span class="attr">ref</span>=<span class="string">"menuTree"</span>&gt;</span><span class="tag">&lt;/<span class="name">el-tree</span>&gt;</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>这样就能拿到这个节点的属性</p>
<p>其实后台开发人员可能也是要写前端的，真正的前端开发人员是写面向用户的前端</p>
</blockquote>
<h4 id="6-slot"><a href="#6-slot" class="headerlink" title="==6.slot=="></a>==6.slot==</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-table-column</span> <span class="attr">prop</span>=<span class="string">"showStatus"</span> <span class="attr">header-align</span>=<span class="string">"center"</span> <span class="attr">align</span>=<span class="string">"center"</span> <span class="attr">label</span>=<span class="string">"显示状态"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">slot-scope</span>=<span class="string">"scope"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-switch</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">v-model</span>=<span class="string">"scope.row.showStatus"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">active-color</span>=<span class="string">"#13ce66"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">inactive-color</span>=<span class="string">"#ff4949"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">:active-value</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">:inactive-value</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">                   @<span class="attr">change</span>=<span class="string">"updateBrandStatus(scope.row)"</span></span></span><br><span class="line"><span class="tag">                   &gt;</span><span class="tag">&lt;/<span class="name">el-switch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-table-column</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>scope中封装了这一列的所有信息</p>
</blockquote>
<h4 id="7-上传文件"><a href="#7-上传文件" class="headerlink" title="==7.上传文件=="></a>==7.上传文件==</h4><p>记得在components中声明要是用哪些组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SingleUpload <span class="keyword">from</span> <span class="string">"@/components/upload/singleUpload"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  components: &#123; SingleUpload &#125;,</span><br><span class="line">  data() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>==因为是直接浏览器向OSS传输文件，所以还存在跨域问题，要在阿里云OSS配置跨域==</p>
<p><img alt="7" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230108212933.png"></p>
<p>如果上传成功后，不能通过直链访问，还要配置bucket的读写权限</p>
<p><img alt="9" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230112140644.png"></p>
<h4 id="8-父子组件传值"><a href="#8-父子组件传值" class="headerlink" title="8.父子组件传值"></a>8.父子组件传值</h4><blockquote>
<p>上传文件</p>
<p>category.vue 树形菜单</p>
</blockquote>
<h5 id="8-1-使用了-emit向父组件中返回值"><a href="#8-1-使用了-emit向父组件中返回值" class="headerlink" title="==8.1 使用了$emit向父组件中返回值=="></a>==8.1 使用了$emit向父组件中返回值==</h5><p>父组件(brand-add-or-update.vue)：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">single-upload</span> <span class="attr">v-model</span>=<span class="string">"dataForm.logo"</span>&gt;</span><span class="tag">&lt;/<span class="name">single-upload</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>子组件(singleUpload.vue)：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">emitInput(val) &#123;</span><br><span class="line">    在这里返回给父组件</span><br><span class="line">    <span class="keyword">this</span>.$emit(<span class="string">'input'</span>, val)</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">handleUploadSuccess(res, file) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"上传成功..."</span>)</span><br><span class="line">        <span class="keyword">this</span>.showFileList = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.fileList.pop();</span><br><span class="line">        <span class="keyword">this</span>.fileList.push(&#123;<span class="attr">name</span>: file.name, <span class="attr">url</span>: <span class="keyword">this</span>.dataObj.host + <span class="string">'/'</span> + <span class="keyword">this</span>.dataObj.key.replace(<span class="string">"$&#123;filename&#125;"</span>,file.name)&#125;);</span><br><span class="line">        <span class="comment">// 在这里返回给父组件logo的地址</span></span><br><span class="line">        <span class="keyword">this</span>.emitInput(<span class="keyword">this</span>.fileList[<span class="number">0</span>].url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="8-2-父组件可以使用-props-把数据传给子组件"><a href="#8-2-父组件可以使用-props-把数据传给子组件" class="headerlink" title="8.2 父组件可以使用 props 把数据传给子组件"></a>8.2 父组件可以使用 props 把数据传给子组件</h5><h4 id="9-表单校验"><a href="#9-表单校验" class="headerlink" title="9.表单校验"></a>9.表单校验</h4><p>默认校验+自定义校验</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><h4 id="1-什么是微服务？"><a href="#1-什么是微服务？" class="headerlink" title="1.什么是微服务？"></a>1.什么是微服务？</h4><h4 id="2-分布式和集群的区别？"><a href="#2-分布式和集群的区别？" class="headerlink" title="2.分布式和集群的区别？"></a>2.分布式和集群的区别？</h4><blockquote>
<p>分布式是将不同的业务分布在不同的地方</p>
<p>集群指的是将几台服务器集中在一起，实现同一业务</p>
<p><img alt="分布式-集群" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230108213120.png"></p>
</blockquote>
<h3 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h3><h4 id="1-nacos-报错endpoint-is-blank"><a href="#1-nacos-报错endpoint-is-blank" class="headerlink" title="1.nacos 报错endpoint is blank"></a>1.nacos 报错endpoint is blank</h4><blockquote>
<p>解决：</p>
<p>在bootstrap.yml中添加</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&gt; spring:</span></span><br><span class="line"><span class="string">&gt;   application:</span></span><br><span class="line"><span class="string">&gt;     name: gulimall-coupon</span></span><br><span class="line"><span class="string">&gt;   cloud:</span></span><br><span class="line"><span class="string">&gt;     nacos:</span></span><br><span class="line"><span class="string">&gt;       config:</span></span><br><span class="line"><span class="string">&gt;         server-addr: localhost:8848</span></span><br><span class="line"><span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>注意是nacos.config而不是nacos.discovery</p>
</blockquote>
<h2 id="高级篇"><a href="#高级篇" class="headerlink" title="高级篇"></a>高级篇</h2><h3 id="要点"><a href="#要点" class="headerlink" title="==要点=="></a>==要点==</h3><h4 id="1-项目中使用elasticsearch"><a href="#1-项目中使用elasticsearch" class="headerlink" title="1.项目中使用elasticsearch"></a>1.项目中使用elasticsearch</h4><p>不仅要把数据存到mysql中，还要存到es中，才能以后调用es的api进行检索</p>
<h4 id="2-使用typeReference封装接口"><a href="#2-使用typeReference封装接口" class="headerlink" title="2.使用typeReference封装接口"></a>2.使用typeReference封装接口</h4><p>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//利用fastjson进行反序列化</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getData</span><span class="params">(TypeReference&lt;T&gt; typeReference)</span> </span>&#123;</span><br><span class="line">    Object data = get(<span class="string">"data"</span>);	<span class="comment">//默认是map</span></span><br><span class="line">    String jsonString = JSON.toJSONString(data);</span><br><span class="line">    T t = JSON.parseObject(jsonString, typeReference);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">R skuHasStock = wareFeignService.getSkuHasStock(skuIdList);</span><br><span class="line"></span><br><span class="line">TypeReference&lt;List&lt;SkuHasStockVo&gt;&gt; typeReference = <span class="keyword">new</span> TypeReference&lt;List&lt;SkuHasStockVo&gt;&gt;() &#123;&#125;;</span><br><span class="line">stockMap = skuHasStock.getData(typeReference).stream()</span><br><span class="line">    .collect(Collectors.toMap(SkuHasStockVo::getSkuId, item -&gt; item.getHasStock()));</span><br></pre></td></tr></table></figure>
<h4 id="3-测试分布式场景"><a href="#3-测试分布式场景" class="headerlink" title="3.测试分布式场景"></a>3.测试分布式场景</h4><p>同一个应用在idea配置那边多复制几份，改下端口，然后运行即可。</p>
<h4 id="4-注意线程池配置"><a href="#4-注意线程池配置" class="headerlink" title="4.注意线程池配置"></a>4.注意线程池配置</h4><blockquote>
<p>放在这里的原因是注意这边的参数注入，学着点</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties</span>(ThreadPoolConfigProperties.class)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThreadConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolExecutor <span class="title">threadPoolExecutor</span><span class="params">(ThreadPoolConfigProperties poolConfigProperties)</span></span>&#123;</span><br><span class="line">        <span class="comment">// poolConfigProperties这边就可以直接从配置文件中获取到</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                poolConfigProperties.getCoreSize(),</span><br><span class="line">                poolConfigProperties.getMaxSize(),</span><br><span class="line">                poolConfigProperties.getKeepAliveTime(),</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;(<span class="number">100000</span>),</span><br><span class="line">                Executors.defaultThreadFactory(),</span><br><span class="line">                <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-feign远程请求丢失请求头"><a href="#5-feign远程请求丢失请求头" class="headerlink" title="5.feign远程请求丢失请求头"></a>5.feign远程请求丢失请求头</h4><p>原因：feign远程调用会创建一个全新的请求，从而丢失了请求头(后面可能导致丢失各种登录状态)</p>
<p><img alt="36" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230210212732.png"></p>
<p>解决</p>
<blockquote>
<p>在feign的RequestInterceptor中加上同步请求头就行了</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GuliFeignConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"requestInterceptor"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestInterceptor <span class="title">requestInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        RequestInterceptor requestInterceptor = <span class="keyword">new</span> RequestInterceptor() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestTemplate template)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//1、使用RequestContextHolder拿到刚进来的请求数据</span></span><br><span class="line">                ServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 主要同步cookie,</span></span><br><span class="line">                <span class="keyword">if</span> (requestAttributes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//老请求</span></span><br><span class="line">                    HttpServletRequest request = requestAttributes.getRequest();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//2、同步请求头的数据（主要是cookie）</span></span><br><span class="line">                        String cookie = request.getHeader(<span class="string">"Cookie"</span>);</span><br><span class="line">                        <span class="comment">//把老请求的cookie值放到新请求上来，进行一个同步(注意这里是设置请求头，而不是localstorage)</span></span><br><span class="line">                        template.header(<span class="string">"Cookie"</span>, cookie);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> requestInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6-feign异步调用丢失上下文信息"><a href="#6-feign异步调用丢失上下文信息" class="headerlink" title="6.feign异步调用丢失上下文信息"></a>6.feign异步调用丢失上下文信息</h4><blockquote>
<p>原因：这里主要是异步调用，异步调用会开启新线程，而新线程中没有请求数据</p>
<p>==说一下这里使用问题5中的RequestInterceptor拦截器为什么没有用？==</p>
<p>因为在cart和address异步线程中RequestContextHolder本来就没有相应的请求信息，所以后面同步cookie自然也没有用。</p>
<p>这个只有主线程请求进来的时候RequestContextHolder中才有请求信息。</p>
<p>所以要做的就是把主线程中RequestContextHolder的请求数据放到cart和address异步线程。</p>
</blockquote>
<p><img alt="37" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230210214712.png"></p>
<h4 id="7-幂等性"><a href="#7-幂等性" class="headerlink" title="==7.幂等性=="></a>==7.幂等性==</h4><blockquote>
<p>有文档</p>
</blockquote>
<h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><p><strong>接口幂等性就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的</strong></p>
<h5 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h5><p>用户多次点击按钮</p>
<p>用户页面回退再次提交</p>
<p>微服务互相调用，由于网络问题，导致请求失败。feign 触发重试机制</p>
<p>其他业务情况</p>
<h5 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h5><h6 id="1-token机制"><a href="#1-token机制" class="headerlink" title="1.token机制"></a>1.token机制</h6><blockquote>
<p>前端传的token和redis的Token一样，就执行业务</p>
</blockquote>
<h6 id="2-锁机制"><a href="#2-锁机制" class="headerlink" title="2.锁机制"></a>2.锁机制</h6><p>乐观锁</p>
<p>悲观锁</p>
<p>业务层分布式锁</p>
<h6 id="3-各种唯一约束"><a href="#3-各种唯一约束" class="headerlink" title="3.各种唯一约束"></a>3.各种唯一约束</h6><p>数据库唯一约束</p>
<p>redis  set防重</p>
<h6 id="4-防重表"><a href="#4-防重表" class="headerlink" title="4.防重表"></a>4.防重表</h6><h6 id="5-全局请求唯一id"><a href="#5-全局请求唯一id" class="headerlink" title="5.全局请求唯一id"></a>5.全局请求唯一id</h6><h3 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><blockquote>
<p>有参考文档</p>
<p>可以快速地<strong>储存、搜索和分析</strong>海量数据</p>
</blockquote>
<h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><blockquote>
<p>可参考</p>
<p><a href="https://blog.csdn.net/Vincent9847/article/details/118244167" target="_blank" rel="noopener">https://blog.csdn.net/Vincent9847/article/details/118244167</a></p>
</blockquote>
<p><img alt="11" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230115212116.png"></p>
<h5 id="1-index-索引-，"><a href="#1-index-索引-，" class="headerlink" title="1.index(索引)，"></a>1.index(索引)，</h5><p>动词，相当于 MySQL 中的 insert；</p>
<p>名词，相当于 MySQL 中的 Database</p>
<h5 id="2-type-类型-，类似于mysql的table"><a href="#2-type-类型-，类似于mysql的table" class="headerlink" title="2.type(类型)，类似于mysql的table"></a>2.type(类型)，类似于mysql的table</h5><h5 id="3-Document-文档-，相当于mysql表中的数据-行"><a href="#3-Document-文档-，相当于mysql表中的数据-行" class="headerlink" title="3.Document(文档)，相当于mysql表中的数据(行)"></a>3.Document(文档)，相当于mysql表中的数据(行)</h5><h5 id="4-倒排索引"><a href="#4-倒排索引" class="headerlink" title="==4.倒排索引=="></a>==4.倒排索引==</h5><p>ElasticSearch搜索为什么很快的原因</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><blockquote>
<p>参考文档</p>
</blockquote>
<p>改变权限</p>
<blockquote>
<p>chmod -R 777 /mydata/elasticsearch/ 保证权限</p>
<p>-R递归所有目录改变权限</p>
</blockquote>
<p>第一次启动ElasticSearch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \</span><br><span class="line">-e &quot;discovery.type=single-node&quot; \</span><br><span class="line">-e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; \</span><br><span class="line">-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line">-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data \</span><br><span class="line">-v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">-d elasticsearch:7.4.2</span><br><span class="line"></span><br><span class="line">9200是http请求接口，9300是分布式集群下的端口</span><br></pre></td></tr></table></figure>
<blockquote>
<p>docker update elasticsearch —restart=always</p>
</blockquote>
<p>第一次启动Kibana</p>
<blockquote>
<p>docker run —name kibana -e ELASTICSEARCH_HOSTS=<a href="http://192.168.56.108:9200" target="_blank" rel="noopener">http://192.168.56.108:9200</a> -p 5601:5601 -d kibana:7.4.2</p>
</blockquote>
<p>如果已启动过</p>
<blockquote>
<p>docker start 进程编号(部分即可)</p>
<p>参考文档</p>
</blockquote>
<p>增删改查+批量操作</p>
<p>批量测试数据地址</p>
<blockquote>
<p><a href="https://gitee.com/xlh_blog/common_content/blob/master/es%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE.json#" target="_blank" rel="noopener">https://gitee.com/xlh_blog/common_content/blob/master/es%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE.json#</a></p>
</blockquote>
<h4 id="高级检索"><a href="#高级检索" class="headerlink" title="高级检索"></a>高级检索</h4><blockquote>
<p>参考文档</p>
</blockquote>
<h5 id="1-SearchAPI"><a href="#1-SearchAPI" class="headerlink" title="1.SearchAPI"></a>1.SearchAPI</h5><blockquote>
<p>GET bank/_search?q=*&amp;sort=account_number:asc</p>
</blockquote>
<p>match,sort..</p>
<h5 id="2-Query-DSL"><a href="#2-Query-DSL" class="headerlink" title="2.Query DSL"></a>2.Query DSL</h5><blockquote>
<p>返回部分字段</p>
<p>匹配查询(match 只要匹配到任意一个单词，默认会分词)(address.keyword就可以匹配精确值(是全等))</p>
<p>短语匹配(全部匹配)</p>
<p>多字段匹配(<strong>multi_match</strong>，多个字段包含指定字符)</p>
<p>复合匹配(bool，这里面的条件必须都要满足(must,should,must_not)</p>
<p>==结果过滤(用在复合匹配中，filter查出结果后过滤，和Must区别就是不贡献相关性得分)==</p>
<p>term(多个就是terms)   和 match一样，匹配某个属性值，但推荐全文检索使用match，其他非text字段匹配使用term</p>
<p>nested用于存储复杂类型(对象)</p>
<p><strong>aggregations</strong>聚合分析结果(平均值，年龄段个数)，类似SQL的group by(求多个年龄段的平均薪资)</p>
</blockquote>
<h5 id="3-Mapping"><a href="#3-Mapping" class="headerlink" title="3.Mapping"></a>3.Mapping</h5><blockquote>
<p>可以类比mybatis</p>
<p>ElasticSearch默认会推断出所以的映射类型，但可以自己指定</p>
</blockquote>
<h5 id="4-分词"><a href="#4-分词" class="headerlink" title="4.分词"></a>4.分词</h5><blockquote>
<p>下载</p>
<p>wget <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip</a></p>
<p>自定义分词</p>
<p>需要借助nginx，nginx安装参考附录</p>
</blockquote>
<h4 id="SpringBoot整合"><a href="#SpringBoot整合" class="headerlink" title="SpringBoot整合"></a>SpringBoot整合</h4><h5 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GulimallElasticSearchConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestOptions COMMON_OPTIONS;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();</span><br><span class="line">        <span class="comment">// builder.addHeader("Authorization", "Bearer " + TOKEN);</span></span><br><span class="line">        <span class="comment">// builder.setHttpAsyncResponseConsumerFactory(</span></span><br><span class="line">        <span class="comment">//         new HttpAsyncResponseConsumerFactory</span></span><br><span class="line">        <span class="comment">//                 .HeapBufferedResponseConsumerFactory(30 * 1024 * 1024 * 1024));</span></span><br><span class="line">        COMMON_OPTIONS = builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">esRestClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> HttpHost(<span class="string">"192.168.77.130"</span>, <span class="number">9200</span>, <span class="string">"http"</span>)));</span><br><span class="line">        <span class="keyword">return</span>  client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="DSL在java中的示例"><a href="#DSL在java中的示例" class="headerlink" title="==DSL在java中的示例=="></a>==DSL在java中的示例==</h5><p>见search服务中的MallSearchServiceImpl#buildSearchRequest</p>
<p>请看P173-192</p>
<h4 id="bug"><a href="#bug" class="headerlink" title="bug"></a>bug</h4><p>181P，分享一个自己遇到的问题：<br>问题：org.elasticsearch.ElasticsearchException: Elasticsearch exception [type=illegal_argument_exception, reason=Can’t load fielddata on 【brandName】 because fielddata is unsupported on fields of type 【keyword】. Use doc values instead.]</p>
<p>思路：出现该错误是因为ES5.x之后，对聚合所依据的字段用单独的数据结构(fielddata)缓存到内存里了，但是在text字段上默认是禁用的，如果有需要单独开启，这样做的目的是为了节省内存空间。<br>具体实现方法可以参考文档或者自行百度。</p>
<p>解决：在字段里加上keyword，例如：<br>.field(“brandName.keyword”)<br>.field(“brandImg.keyword”)<br>.field(“catalogName.keyword”)<br>.field(“attrs.attrName.keyword”)</p>
<h3 id="nginx"><a href="#nginx" class="headerlink" title="==nginx=="></a>==nginx==</h3><blockquote>
<p>1.保护了真实的web服务器</p>
<p>2.方便动静分离和负载均衡</p>
</blockquote>
<h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><blockquote>
<p>详情见文档</p>
<p>1.随便启动一个 nginx 实例，只是为了复制出配置</p>
<p>docker run -p 80:80 —name nginx -d nginx:1.10</p>
<p>2.将容器内的配置文件拷贝到当前目录：docker container cp nginx:/etc/nginx . </p>
<p><strong>别忘了后面的点</strong></p>
<p>3.修改文件名称：mv nginx conf 把这个 conf 移动到/mydata/nginx 下</p>
<p>4.终止原容器：docker stop nginx</p>
<p>5.执行命令删除原容器：docker rm $ContainerId</p>
<p>6.创建新的 nginx；执行以下命令</p>
<p>启动</p>
<p>docker run -p 80:80 —name nginx -v /mydata/nginx/html:/usr/share/nginx/html -v /mydata/nginx/logs:/var/log/nginx -v /mydata/nginx/conf:/etc/nginx -d nginx:1.10</p>
</blockquote>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>详情</p>
<p><img alt="img" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230201212605.png"></p>
<h4 id="使用nginx反向代理"><a href="#使用nginx反向代理" class="headerlink" title="==使用nginx反向代理=="></a>==使用nginx反向代理==</h4><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p><img alt="img" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230201213548.png"></p>
<p>步骤：</p>
<p>1.用户访问gulimall.com(由于是本地测试，这边只是改了本地的hosts模仿DNS域名解析器)，发到nginx</p>
<p>==tips：记住不能挂VPN，否则DNS解析默认走代理服务器，不会走Hosts文件中配置的地址==</p>
<p>2.nginx监听gulimall.com这个域名，监听到请求就发给proxy_pass配置的后台服务器(这里配置的是网关，网关再转发给相应的服务器)</p>
<p>3.网关根据路由规则，匹配后台服务器</p>
<p>4.转到后台服务器调用接口。</p>
<h5 id="不改进"><a href="#不改进" class="headerlink" title="不改进"></a>不改进</h5><p>配置文件</p>
<p>conf.d/default.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  gulimall.com; # nginx监听客户端访问的域名(ip地址),然后根据下面配置的转发给相应的后台服务器</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/log/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://192.168.56.1:10000; # 转发给相应的服务器,这里是本机(不是虚拟机)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h5><p>==将转发的地址改为网关的地址==</p>
<p>nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">    upstream gulimall&#123; # 这里的gulimall和default.conf中对应</span><br><span class="line">        server 192.168.56.1:88; # 配置上游服务器的地址,即网关地址</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>conf.d/default.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  gulimall.com; # nginx监听客户端访问的域名(ip地址),然后根据下面配置的转发给相应的后台服务器</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/log/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">    	proxy_set_header Host $host; # nginx给网关转发的时候会丢掉host,不补上识别不到,所以要加上</span><br><span class="line">        proxy_pass http://gulimall; # 默认转发给上游服务器(网关),之后再负载均衡的转给各个服务器</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>网关的yml配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- id:</span> <span class="string">gulimall_host_route</span></span><br><span class="line">	<span class="attr">uri:</span> <span class="attr">lb://gulimall-product</span></span><br><span class="line">	<span class="attr">predicates:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">Host=gulimall.com,item.gulimall.com</span></span><br></pre></td></tr></table></figure>
<h4 id="使用nginx实现动静分离"><a href="#使用nginx实现动静分离" class="headerlink" title="==使用nginx实现动静分离=="></a>==使用nginx实现动静分离==</h4><p>简单来说就是，静态资源不要放到后台服务器，这样会直接请求到tomcat，</p>
<p>而是应该把静态资源放到nginx，让用户去直接请求nginx得到这些静态资源，缓解后台tomcat的压力。</p>
<p><img alt="14" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230202162959.png"></p>
<p>在conf.d/gulimall.conf中配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  gulimall.com; # nginx监听客户端访问的域名(ip地址),然后根据下面配置的转发给相应的后台服务器</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/log/host.access.log  main;</span><br><span class="line">    ##############################看这里##########################</span><br><span class="line">    location /static/&#123;</span><br><span class="line">    	root /usr/share/nginx/html;  # 注意这边是nginx的/bin/bash里面的路径，而不是外头的路径</span><br><span class="line">    &#125;</span><br><span class="line">    ##############################看这里##########################</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">    	proxy_set_header Host $host; # nginx给网关转发的时候会丢掉host,不补上识别不到,所以要加上</span><br><span class="line">        proxy_pass http://gulimall; # 默认转发给上游服务器(网关),之后再负载均衡的转给各个服务器</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h3><h4 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h4><p>TPS:系统每秒处理交易数，单位是笔/秒。</p>
<p>QPS:系统每秒处理查询次数，单位是次/秒</p>
<p>一般情况下：</p>
<p>金融行业：1000TPS~50000TPS，不包括互联网化的活动</p>
<p>保险行业：100TPS~100000TPS，不包括互联网化的活动</p>
<p>制造行业：10TPS~5000TPS</p>
<p>互联网电子商务：10000TPS~1000000TPS</p>
<p>互联网中型网站：1000TPS~50000TPS</p>
<p>互联网小型网站：500TPS~10000TPS</p>
<h4 id="Jemter工具"><a href="#Jemter工具" class="headerlink" title="Jemter工具"></a>Jemter工具</h4><p><a href="https://jmeter.apache.org/download_jmeter.cgi" target="_blank" rel="noopener">下载</a></p>
<p>具体使用见资料</p>
<h5 id="bug-1"><a href="#bug-1" class="headerlink" title="bug"></a>bug</h5><p>报错：<strong>JMeter Address Already in use</strong></p>
<blockquote>
<p>windows 本身提供的端口访问机制的问题。</p>
<p>Windows 提供给 TCP/IP 链接的端口为 1024-5000，并且要四分钟来循环回收他们。就导致</p>
<p>我们在短时间内跑大量的请求时将端口占满了。</p>
<p>1.cmd 中，用 regedit 命令打开注册表</p>
<p>2.在 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters 下，</p>
<p>1 .右击 parameters，添加一个新的 DWORD，名字为 MaxUserPort</p>
<p>2 .然后双击 MaxUserPort，输入数值数据为 65534，基数选择十进制（如果是分布式运</p>
<p>行的话，控制机器和负载机器都需要这样操作哦）</p>
<ol>
<li>修改配置完毕之后记得重启机器才会生效</li>
</ol>
<p><a href="https://support.microsoft.com/zh-cn/help/196271/when-you-try-to-connect-from-tcp-ports-grea" target="_blank" rel="noopener">https://support.microsoft.com/zh-cn/help/196271/when-you-try-to-connect-from-tcp-ports-grea</a></p>
<p>ter-than-5000-you-receive-t</p>
<p>TCPTimedWaitDelay：30</p>
</blockquote>
<h3 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h3><h4 id="jvisualvm"><a href="#jvisualvm" class="headerlink" title="jvisualvm"></a>jvisualvm</h4><p>jvisualvm是升级版的jconsole，所以一般都使用jvisualvm，Jmeter压测配合jvisualvm观察</p>
<p>==下图是课上压测的结果==</p>
<p><img alt="13" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230202155547.png"></p>
<p>==结论(优化方向)==：</p>
<p>中间件越多，性能损失越大，大多都损失在网络交互了；</p>
<p>业务：</p>
<p>​    Db（MySQL 优化）</p>
<p>​    模板的渲染速度（缓存）</p>
<p>​    静态资源</p>
<h3 id="缓存与分布式锁-Redis"><a href="#缓存与分布式锁-Redis" class="headerlink" title="==缓存与分布式锁(Redis)=="></a>==缓存与分布式锁(Redis)==</h3><p>使用redis做分布式缓存架构图</p>
<p><img alt="img" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230202181916.png"></p>
<h4 id="安装与启动"><a href="#安装与启动" class="headerlink" title="安装与启动"></a>安装与启动</h4><blockquote>
<p>安装</p>
<p>docker pull redis</p>
<p>配置</p>
<p>mkdir -p /mydata/redis/conf</p>
<p>touch /mydata/redis/conf/redis.conf</p>
<p>启动</p>
<p>docker run -p 6379:6379 —name redis -v /mydata/redis/data:/data -v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf -d redis redis-server /etc/redis/redis.conf</p>
<p>设置开机自动启动</p>
<p>docker update redis —restart=always</p>
<p>以redis-cli进入内部</p>
<p>docker exec -it redis redis-cli</p>
</blockquote>
<h4 id="SpringBoot整合-1"><a href="#SpringBoot整合-1" class="headerlink" title="SpringBoot整合"></a>SpringBoot整合</h4><p>导入依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 引入redis --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;io.lettuce&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">lettuce会产生堆外内存溢出OutOfDirectMemoryError:</span><br><span class="line">//1)、springboot2.0以后默认使用lettuce操作redis的客户端，它使用通信</span><br><span class="line">//2)、lettuce的bug导致netty堆外内存溢出   可设置：-Dio.netty.maxDirectMemory</span><br><span class="line">//解决方案：不能直接使用-Dio.netty.maxDirectMemory去调大堆外内存</span><br><span class="line">//1)、升级lettuce客户端。      2）、切换使用jedis</span><br></pre></td></tr></table></figure>
<p>配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">redis:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.108</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>
<p>注入StringRedisTemplate进行使用</p>
<h4 id="本地锁"><a href="#本地锁" class="headerlink" title="本地锁"></a>本地锁</h4><p>synchronized，juc(lock)只能锁住当前进程，在分布式场景下想要锁住所有的必须使用分布式锁</p>
<p><img alt="15" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230202201550.png"></p>
<h4 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h4><p>原理图</p>
<p><img alt="16" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230202203300.png"></p>
<p>==实现过程中有好多坑，详细可以看资料图以及视频P158==</p>
<p>代码</p>
<p>==获取锁和设置过期时间必须是原子操作，否则很可能会有并发问题==</p>
<p>==删除锁+判断锁也是要原子操作(使用lua脚本)==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从数据库查询并封装数据::分布式锁</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; getCatalogJsonFromDbWithRedisLock() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、占分布式锁。去redis占坑      设置过期时间必须和加锁是同步的，保证原子性（避免死锁）</span></span><br><span class="line">    String uuid = UUID.randomUUID().toString();</span><br><span class="line">    Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(<span class="string">"lock"</span>, uuid,<span class="number">300</span>,TimeUnit.SECONDS);<span class="comment">// 相当于setnxex</span></span><br><span class="line">    <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">        System.out.println(<span class="string">"获取分布式锁成功..."</span>);</span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; dataFromDb = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//加锁成功...执行业务</span></span><br><span class="line">            dataFromDb = getDataFromDb();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 使用Lua脚本</span></span><br><span class="line">            String script = <span class="string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//删除锁</span></span><br><span class="line">            stringRedisTemplate.execute(<span class="keyword">new</span> DefaultRedisScript&lt;Long&gt;(script, Long.class), Arrays.asList(<span class="string">"lock"</span>), uuid);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//先去redis查询下保证当前的锁是自己的</span></span><br><span class="line">        <span class="comment">//获取值对比，对比成功删除=原子性 lua脚本解锁</span></span><br><span class="line">        <span class="comment">// String lockValue = stringRedisTemplate.opsForValue().get("lock");</span></span><br><span class="line">        <span class="comment">// if (uuid.equals(lockValue)) &#123;</span></span><br><span class="line">        <span class="comment">//     //删除我自己的锁</span></span><br><span class="line">        <span class="comment">//     stringRedisTemplate.delete("lock");</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dataFromDb;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"获取分布式锁失败...等待重试..."</span>);</span><br><span class="line">        <span class="comment">//加锁失败...重试机制</span></span><br><span class="line">        <span class="comment">//休眠一百毫秒</span></span><br><span class="line">        <span class="keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">        <span class="keyword">return</span> getCatalogJsonFromDbWithRedisLock();     <span class="comment">//自旋的方式</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用Redisson实现分布式锁"><a href="#使用Redisson实现分布式锁" class="headerlink" title="使用Redisson实现分布式锁"></a>使用Redisson实现分布式锁</h4><blockquote>
<p>一个实现了分布式锁的框架，包括所有JUC锁的分布式版</p>
</blockquote>
<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedissonConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有对Redisson的使用都是通过RedissonClient</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(destroyMethod=<span class="string">"shutdown"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonClient <span class="title">redisson</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//1、创建配置</span></span><br><span class="line">        Config config = <span class="keyword">new</span> Config();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">"redis://192.168.56.108:6379"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、根据Config创建出RedissonClient实例</span></span><br><span class="line">        <span class="comment">//Redis url should start with redis:// or rediss://</span></span><br><span class="line">        RedissonClient redissonClient = Redisson.create(config);</span><br><span class="line">        <span class="keyword">return</span> redissonClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="阻塞锁Rlock测试"><a href="#阻塞锁Rlock测试" class="headerlink" title="阻塞锁Rlock测试"></a>阻塞锁Rlock测试</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/hello"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、获取一把锁，只要锁的名字一样，就是同一把锁</span></span><br><span class="line">    RLock myLock = redisson.getLock(<span class="string">"my-lock"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、加锁</span></span><br><span class="line">    myLock.lock();      <span class="comment">//阻塞式等待。默认加的锁都是30s</span></span><br><span class="line">    <span class="comment">//1）、锁的自动续期，如果业务超长，运行期间自动锁上新的30s。不用担心业务时间长，锁自动过期被删掉</span></span><br><span class="line">    <span class="comment">//2）、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认会在30s内自动过期，不会产生死锁问题</span></span><br><span class="line">    <span class="comment">// myLock.lock(10,TimeUnit.SECONDS);   //10秒钟自动解锁,自动解锁时间一定要大于业务执行时间</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//问题：在锁时间到了以后，不会自动续期</span></span><br><span class="line">    <span class="comment">//1、如果我们传递了锁的超时时间，就发送给redis执行脚本，进行占锁，默认超时就是 我们制定的时间  myLock.lock(10,TimeUnit.SECONDS);   </span></span><br><span class="line">    <span class="comment">//2、如果我们未指定锁的超时时间，就使用 lockWatchdogTimeout = 30 * 1000 【看门狗默认时间】   myLock.lock(); </span></span><br><span class="line">    <span class="comment">//只要占锁成功，就会启动一个定时任务【重新给锁设置过期时间，新的过期时间就是看门狗的默认时间】,每隔10秒都会自动的再次续期，续成30秒</span></span><br><span class="line">    <span class="comment">// internalLockLeaseTime 【看门狗时间】 / 3， 10s</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 最佳实践:省去了看门狗机制,手动指定大一点的超时时间</span></span><br><span class="line">    <span class="comment">// myLock.lock(30,TimeUnit.SECONDS); </span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"加锁成功，执行业务..."</span> + Thread.currentThread().getId());</span><br><span class="line">        <span class="keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="number">20</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//3、解锁  假设解锁代码没有运行，Redisson会不会出现死锁</span></span><br><span class="line">        System.out.println(<span class="string">"释放锁..."</span> + Thread.currentThread().getId());</span><br><span class="line">        myLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>==重要==</p>
<p>redisson</p>
<p>1）、==锁的自动续期==，如果业务超长，运行期间自动锁上新的30s。不用担心业务时间长，锁自动过期被删掉<br>2）、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认会在30s内自动过期，不会产生死锁问题</p>
<h5 id="读写锁RReadWriteLock测试"><a href="#读写锁RReadWriteLock测试" class="headerlink" title="读写锁RReadWriteLock测试"></a>读写锁RReadWriteLock测试</h5><blockquote>
<p>改数据加写锁，读数据加读锁(操作系统中读写者问题)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保证一定能读到最新数据，修改期间，写锁是一个排它锁（互斥锁、独享锁），读锁是一个共享锁</span></span><br><span class="line"><span class="comment">     * 写锁没释放读锁必须等待</span></span><br><span class="line"><span class="comment">     * 读 + 读 ：相当于无锁，并发读，只会在Redis中记录好，所有当前的读锁。他们都会同时加锁成功</span></span><br><span class="line"><span class="comment">     * 写 + 读 ：必须等待写锁释放</span></span><br><span class="line"><span class="comment">     * 写 + 写 ：阻塞方式</span></span><br><span class="line"><span class="comment">     * 读 + 写 ：有读锁。写也需要等待</span></span><br><span class="line"><span class="comment">     * 只要有读或者写的存都必须等待</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/write"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">writeValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String s = <span class="string">""</span>;</span><br><span class="line">    RReadWriteLock readWriteLock = redisson.getReadWriteLock(<span class="string">"rw-lock"</span>);</span><br><span class="line">    RLock rLock = readWriteLock.writeLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//1、改数据加写锁，读数据加读锁</span></span><br><span class="line">        rLock.lock();</span><br><span class="line">        s = UUID.randomUUID().toString();</span><br><span class="line">        ValueOperations&lt;String, String&gt; ops = stringRedisTemplate.opsForValue();</span><br><span class="line">        ops.set(<span class="string">"writeValue"</span>,s);</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        rLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/read"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">readValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String s = <span class="string">""</span>;</span><br><span class="line">    RReadWriteLock readWriteLock = redisson.getReadWriteLock(<span class="string">"rw-lock"</span>);</span><br><span class="line">    <span class="comment">//加读锁</span></span><br><span class="line">    RLock rLock = readWriteLock.readLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rLock.lock();</span><br><span class="line">        ValueOperations&lt;String, String&gt; ops = stringRedisTemplate.opsForValue();</span><br><span class="line">        s = ops.get(<span class="string">"writeValue"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="number">10</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        rLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="信号量Semaphore测试"><a href="#信号量Semaphore测试" class="headerlink" title="信号量Semaphore测试"></a>信号量Semaphore测试</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 车库停车</span></span><br><span class="line"><span class="comment"> * 3车位</span></span><br><span class="line"><span class="comment"> * 信号量也可以做分布式限流</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/park"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">park</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">    RSemaphore park = redisson.getSemaphore(<span class="string">"park"</span>);</span><br><span class="line">    park.acquire();     <span class="comment">//获取一个信号、获取一个值,占一个车位</span></span><br><span class="line">    <span class="keyword">boolean</span> flag = park.tryAcquire();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;<span class="comment">// 成功获取到锁</span></span><br><span class="line">        <span class="comment">//执行业务</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ok=&gt;"</span> + flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/go"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">go</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RSemaphore park = redisson.getSemaphore(<span class="string">"park"</span>);</span><br><span class="line">    park.release();     <span class="comment">//释放一个车位</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ok"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="闭锁CountDownLatch测试"><a href="#闭锁CountDownLatch测试" class="headerlink" title="闭锁CountDownLatch测试"></a>闭锁CountDownLatch测试</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 放假、锁门</span></span><br><span class="line"><span class="comment"> * 1班没人了</span></span><br><span class="line"><span class="comment"> * 5个班，全部走完，我们才可以锁大门</span></span><br><span class="line"><span class="comment"> * 分布式闭锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/lockDoor"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">lockDoor</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">    RCountDownLatch door = redisson.getCountDownLatch(<span class="string">"door"</span>);</span><br><span class="line">    door.trySetCount(<span class="number">5</span>);</span><br><span class="line">    door.await();       <span class="comment">//等待闭锁完成</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"放假了..."</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/gogogo/&#123;id&#125;"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">gogogo</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id) </span>&#123;</span><br><span class="line">    RCountDownLatch door = redisson.getCountDownLatch(<span class="string">"door"</span>);</span><br><span class="line">    door.countDown();       <span class="comment">//计数-1</span></span><br><span class="line">    <span class="keyword">return</span> id + <span class="string">"班的人都走了..."</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="缓存数据库一致性问题"><a href="#缓存数据库一致性问题" class="headerlink" title="缓存数据库一致性问题"></a>缓存数据库一致性问题</h4><h5 id="双写模式"><a href="#双写模式" class="headerlink" title="双写模式"></a>双写模式</h5><p><img alt="17" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230204202833.png"></p>
<h5 id="失效模式"><a href="#失效模式" class="headerlink" title="失效模式"></a>失效模式</h5><p><img alt="18" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230204203036.png"></p>
<h5 id="都会有脏数据问题-解决方案"><a href="#都会有脏数据问题-解决方案" class="headerlink" title="都会有脏数据问题(解决方案)"></a>都会有脏数据问题(解决方案)</h5><p>1、对于并发几率很小的数据(如个人维度的订单数据、用户数据等)，这种几乎不用考虑这个问题，很少会发生缓存不一致，可以给缓存数据加上过期时间，每隔一段时间触发读的主动更新即可。</p>
<p>2、就算并发很高，如果业务上能容忍短时间的缓存数据不一致(如商品名称，商品分类菜单等)，缓存加上过期时间依然可以解决大部分业务对于缓存的要求。</p>
<p>3、如果不能容忍缓存数据不一致，可以通过加<strong>读写锁</strong>保证并发读写或写写的时候按顺序排好队，<strong>读读的时候相当于无锁</strong>。</p>
<p>4、也可以用阿里开源的canal通过监听数据库的binlog日志及时的去修改缓存，但是引入了新的中间件，增加了系统的复杂度。</p>
<p><img alt="19" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230204203615.png"></p>
<p><strong>总结：</strong></p>
<p>以上我们针对的都是<strong>读多写少</strong>的情况加入缓存提高性能，如果<strong>写多读多</strong>的情况又不能容忍缓存数据不一致，那就没必要加缓存了，可以直接操作数据库。放入缓存的数据应该是对实时性、一致性要求不是很高的数据。切记不要为了用缓存，同时又要保证绝对的一致性做大量的过度设计和控制，增加系统复杂性！</p>
<h3 id="SpringCache"><a href="#SpringCache" class="headerlink" title="SpringCache"></a>SpringCache</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>SpringCache是用来整合缓存的框架，==简化缓存判断操作==</p>
<p><img alt="20" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230204210113.png"></p>
<p>Cache 接口为缓存的组件规范定义，包含缓存的各种操作集合；Cache 接 口 下 Spring 提 供 了 各 种 xxxCache 的 实 现 ； 如 RedisCache ， EhCacheCache , </p>
<p>ConcurrentMapCache 等；</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置类上配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GulimallProductApplication</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>yml中设置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">    cache:</span></span><br><span class="line">      	<span class="attr">type:</span> <span class="string">redis</span></span><br><span class="line">      	<span class="comment"># 下面的配置可选</span></span><br><span class="line">      	<span class="attr">redis:</span></span><br><span class="line"><span class="attr">          time-to-live:</span> <span class="number">3600000</span></span><br><span class="line">          <span class="comment"># 如果指定了前缀就用我们指定的前缀，如果没有就默认使用缓存的名字(Value)作为前缀</span></span><br><span class="line"><span class="attr">          key-prefix:</span> <span class="string">CHCHE_</span></span><br><span class="line"><span class="attr">          use-key-prefix:</span> <span class="literal">true</span></span><br><span class="line">          <span class="comment"># 是否缓存空值,防止缓存穿透</span></span><br><span class="line"><span class="attr">          cache-null-values:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h4><p><img alt="21" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230204210737.png"></p>
<h5 id="Cacheable"><a href="#Cacheable" class="headerlink" title="@Cacheable"></a>@Cacheable</h5><p>细节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">1.每一个需要缓存的数据我们都来指定要放到那个名字的缓存。【缓存的分区(按照业务类型分)】</span><br><span class="line">2.代表当前方法的结果需要缓存，如果缓存中有，方法都不用调用，如果缓存中没有，会调用方法。最后将方法的结果放入缓存</span><br><span class="line">3.默认行为</span><br><span class="line">     如果缓存中有，方法不再调用</span><br><span class="line">      key是默认生成的:     缓存的名字(即设置的value值)::SimpleKey::[](自动生成key值)</span><br><span class="line">      缓存的value值，默认使用jdk序列化机制，将序列化的数据存到redis中</span><br><span class="line">      默认时间是 -1：</span><br><span class="line"></span><br><span class="line">   自定义操作：key的生成</span><br><span class="line">      指定生成缓存的key：key属性指定，接收一个Spel</span><br><span class="line">      指定缓存的数据的存活时间:配置文档中修改存活时间</span><br><span class="line">      将数据保存为json格式 :</span><br><span class="line">          容器中没有RedisCacheConfiguration就用默认的配置</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 4、Spring-Cache的不足之处：</span><br><span class="line">  1）、读模式</span><br><span class="line">      缓存穿透：查询一个null数据。解决方案：缓存空数据</span><br><span class="line">      缓存击穿：大量并发进来同时查询一个正好过期的数据。解决方案：加锁 ? 默认是无加锁的;使用sync = true来解决击穿问题</span><br><span class="line">      缓存雪崩：大量的key同时过期。解决：加随机时间。加上过期时间</span><br><span class="line">  2)、写模式：（缓存与数据库一致）</span><br><span class="line">      1）、读写加锁。</span><br><span class="line">      2）、引入Canal,感知到MySQL的更新去更新Redis</span><br><span class="line">      3）、读多写多，直接去数据库查询就行</span><br><span class="line"> </span><br><span class="line">  总结：</span><br><span class="line">      常规数据（读多写少，即时性，一致性要求不高的数据，完全可以使用Spring-Cache）：写模式(只要缓存的数据有过期时间就足够了)</span><br><span class="line">      特殊数据：特殊设计</span><br><span class="line"></span><br><span class="line">  原理：</span><br><span class="line">      CacheManager(RedisCacheManager)-&gt;Cache(RedisCache)-&gt;Cache负责缓存的读写</span><br></pre></td></tr></table></figure>
<p>实际使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(value = &#123;<span class="string">"category"</span>&#125;,key = <span class="string">"#root.method.name"</span>,sync = <span class="keyword">true</span>)</span><br><span class="line"><span class="comment">// 第一次执行下面方法，并把返回值放入缓存,第二次缓存中有值，就不用走下面方法</span></span><br><span class="line"><span class="comment">// redis中存的key就是上面value和key的结合,sync=true用于解决缓存击穿加锁</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title">getLevel1Categorys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"getLevel1Categorys........"</span>);</span><br><span class="line">    <span class="keyword">long</span> l = System.currentTimeMillis();</span><br><span class="line">    List&lt;CategoryEntity&gt; categoryEntities = <span class="keyword">this</span>.baseMapper.selectList(</span><br><span class="line">            <span class="keyword">new</span> QueryWrapper&lt;CategoryEntity&gt;().eq(<span class="string">"parent_cid"</span>, <span class="number">0</span>));</span><br><span class="line">    System.out.println(<span class="string">"消耗时间："</span>+ (System.currentTimeMillis() - l));</span><br><span class="line">    <span class="keyword">return</span> categoryEntities;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义数据(key和value)在redis中的保存形式(这边自定义为json)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties</span>(CacheProperties.class)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCacheConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheConfiguration <span class="title">redisCacheConfiguration</span><span class="params">(CacheProperties cacheProperties)</span> </span>&#123;</span><br><span class="line">        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">        config = config.serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> StringRedisSerializer()))</span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer()));</span><br><span class="line">        CacheProperties.Redis redisProperties = cacheProperties.getRedis();</span><br><span class="line">        <span class="comment">//将配置文件中所有的配置都生效</span></span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getTimeToLive() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            config = config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getKeyPrefix() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            config = config.prefixKeysWith(redisProperties.getKeyPrefix());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">            config = config.disableCachingNullValues();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">            config = config.disableKeyPrefix();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="CacheEvict"><a href="#CacheEvict" class="headerlink" title="@CacheEvict"></a>@CacheEvict</h5><p>缓存数据库一致性中的删除模式使用这个注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheEvict</span>(value = <span class="string">"category"</span>,allEntries = <span class="keyword">true</span>)</span><br></pre></td></tr></table></figure>
<h5 id="CachePut"><a href="#CachePut" class="headerlink" title="@CachePut"></a>@CachePut</h5><p>适用于双写模式，更新缓存</p>
<h5 id="Caching"><a href="#Caching" class="headerlink" title="@Caching"></a>@Caching</h5><p>用于组合缓存注解，比如下面方法结束后，从redis中删除多个缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Caching</span>(evict = &#123;</span><br><span class="line">        <span class="meta">@CacheEvict</span>(value = <span class="string">"category"</span>,key = <span class="string">"'getLevel1Categorys'"</span>),</span><br><span class="line">        <span class="meta">@CacheEvict</span>(value = <span class="string">"category"</span>,key = <span class="string">"'getCatalogJson'"</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>删除指定某个分区也能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheEvict</span>(value = <span class="string">"category"</span>,allEntries = <span class="keyword">true</span>)</span><br></pre></td></tr></table></figure>
<h4 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h4><h5 id="读模式"><a href="#读模式" class="headerlink" title="读模式"></a>读模式</h5><p>缓存穿透：解决-缓存空数据(cache-null-values=true)</p>
<p>缓存击穿：解决-加锁(只准有一个线程进入mysql)？@Cacheable(sync=true)</p>
<p>缓存雪崩：解决-随机过期时间</p>
<h5 id="写模式-缓存数据库不一致"><a href="#写模式-缓存数据库不一致" class="headerlink" title="写模式(缓存数据库不一致)"></a>写模式(缓存数据库不一致)</h5><p>读写加锁(读写锁)</p>
<p>引入canal，感知mysql的Binlog更新去更新数据库</p>
<p>读多写多，直接去查数据库</p>
<h3 id="异步"><a href="#异步" class="headerlink" title="==异步=="></a>==异步==</h3><p>3种方式创建线程</p>
<p>Thread,Runnable,Callable</p>
<p>此外还有线程池，使用线程池可以降低资源消耗，有效管理线程。</p>
<h4 id="CompletableFuture异步编排"><a href="#CompletableFuture异步编排" class="headerlink" title="CompletableFuture异步编排"></a>CompletableFuture异步编排</h4><blockquote>
<p>详细见文档</p>
</blockquote>
<p>不同的异步任务可能存在关联 ，就需要用到异步编排，类似前端的promise</p>
<blockquote>
<p><strong>方法不以</strong> <strong>Async</strong> <strong>结尾，意味着</strong> <strong>Action</strong> <strong>使用相同的线程执行，而</strong> <strong>Async</strong> <strong>可能会使用其他线程</strong></p>
<p><strong>执行（如果是使用相同的线程池，也可能会被同一个线程选中执行）</strong></p>
</blockquote>
<h5 id="初步使用-1"><a href="#初步使用-1" class="headerlink" title="初步使用"></a>初步使用</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">    <span class="number">20</span>,</span><br><span class="line">    <span class="number">100</span>,</span><br><span class="line">    <span class="number">10L</span>,</span><br><span class="line">    TimeUnit.SECONDS,</span><br><span class="line">    <span class="keyword">new</span> LinkedBlockingDeque&lt;Runnable&gt;(<span class="number">10000</span>),</span><br><span class="line">    Executors.defaultThreadFactory(),</span><br><span class="line">    <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy()</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 没返回值</span></span><br><span class="line">CompletableFuture.runAsync(()-&gt;&#123;</span><br><span class="line">    System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">"运行结果："</span> + i);</span><br><span class="line">&#125;,executor);</span><br><span class="line"><span class="comment">// 有返回值</span></span><br><span class="line">CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">"运行结果："</span> + i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor);</span><br><span class="line"></span><br><span class="line">System.out.println(future.get());</span><br></pre></td></tr></table></figure>
<h5 id="回调方法"><a href="#回调方法" class="headerlink" title="回调方法"></a>回调方法</h5><blockquote>
<p>whenComplete:方法执行完，不管成没成功都会调用</p>
<p>exceptionally:发生异常调用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">"运行结果："</span> + i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor).whenComplete((res,exception)-&gt;&#123;<span class="comment">// 不管完没完成都会调用,相当于finally</span></span><br><span class="line">    <span class="comment">// 不能处理返回结果</span></span><br><span class="line">    System.out.println(<span class="string">"异步任务成功完成了...结果是："</span> + res + <span class="string">"异常是："</span> + exception);</span><br><span class="line">&#125;).exceptionally((throwable -&gt; &#123;<span class="comment">// 异常调用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<h5 id="handle"><a href="#handle" class="headerlink" title="handle()"></a>handle()</h5><blockquote>
<p>用于方法执行成功后处理</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">"运行结果："</span> + i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor).handle((result,thr) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> result * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (thr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">"异步任务成功完成了...结果是："</span> + result + <span class="string">"异常是："</span> + thr);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h5 id="串行化"><a href="#串行化" class="headerlink" title="串行化"></a>串行化</h5><blockquote>
<p>业务场景：A执行完再执行B</p>
<p>thenApply 方法：当一个线程依赖另一个线程时，获取上一个任务返回的结果，并返回当前任务的返回值。(能接受上一步结果，有返回值)</p>
<p>thenAccept 方法：消费处理结果。接收任务的处理结果，并消费处理，无返回结果。(能接受上一步结果，但是无返回值)</p>
<p>thenRun 方法：只要上面的任务执行完成，就开始执行 thenRun，只是处理完任务后，执行thenRun 的后续操作（不能获取上一步的执行结果）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Void&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">"运行结果："</span> + i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor).thenAccept((res)-&gt;&#123;</span><br><span class="line">    System.out.println(<span class="number">11</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//                .thenApplyAsync(res -&gt; &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println("任务2启动了..." + res);</span></span><br><span class="line"><span class="comment">//            return "Hello" + res;</span></span><br><span class="line"><span class="comment">//        &#125;, executor);</span></span><br></pre></td></tr></table></figure>
<h5 id="两个任务都要完成"><a href="#两个任务都要完成" class="headerlink" title="两个任务都要完成"></a>两个任务都要完成</h5><blockquote>
<p>两个任务都完成，再执行后面的</p>
<p>thenCombine：组合两个 future，获取两个 future 的返回结果，并返回当前任务的返回值</p>
<p>thenAcceptBoth：组合两个 future，获取两个 future 任务的返回结果，然后处理任务，没有返回值。</p>
<p>runAfterBoth：组合两个 future，不需要获取 future 的结果，只需两个 future 处理完任务后，处理该任务。</p>
<p><strong>方法不以</strong> <strong>Async</strong> <strong>结尾，意味着</strong> <strong>Action</strong> <strong>使用相同的线程执行，而</strong> <strong>Async</strong> <strong>可能会使用其他线程</strong></p>
<p><strong>执行（如果是使用相同的线程池，也可能会被同一个线程选中执行）</strong></p>
<p>使用方法同上面的回调方法</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">"运行结果："</span> + i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor);</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"当前线程2："</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">"运行结果2："</span> + i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor);</span><br><span class="line">future1.runAfterBothAsync(future2,()-&gt;&#123;<span class="comment">// 这个任务是两个任务都执行完再执行的任务</span></span><br><span class="line">    System.out.println(<span class="string">"任务三"</span>);</span><br><span class="line">&#125;,executor);</span><br><span class="line">future1.thenAcceptBothAsync(future2,(res1,res2)-&gt;&#123;<span class="comment">// 这个任务是两个任务都执行完再执行的任务</span></span><br><span class="line">    System.out.println(res1+<span class="string">"："</span>+res2);</span><br><span class="line">&#125;,executor);</span><br></pre></td></tr></table></figure>
<h5 id="两个任务只要一个完成"><a href="#两个任务只要一个完成" class="headerlink" title="两个任务只要一个完成"></a>两个任务只要一个完成</h5><blockquote>
<p>applyToEither：两个任务有一个执行完成，获取它的返回值，处理任务并有新的返回值。</p>
<p>acceptEither：两个任务有一个执行完成，获取它的返回值，处理任务，没有新的返回值。</p>
<p>runAfterEither：两个任务有一个执行完成，不需要获取 future 的结果，处理任务，也没有返回值。</p>
<p><strong>方法不以</strong> <strong>Async</strong> <strong>结尾，意味着</strong> <strong>Action</strong> <strong>使用相同的线程执行，而</strong> <strong>Async</strong> <strong>可能会使用其他线程</strong></p>
<p><strong>执行（如果是使用相同的线程池，也可能会被同一个线程选中执行）</strong></p>
</blockquote>
<h5 id="多任务组合"><a href="#多任务组合" class="headerlink" title="多任务组合"></a>多任务组合</h5><blockquote>
<p>allOf：等待所有任务完成</p>
<p>anyOf：只要有一个任务完成</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"当前线程："</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">"运行结果："</span> + i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor);</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"当前线程2："</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">"运行结果2："</span> + i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor);</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;Integer&gt; future3 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"当前线程3："</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">"运行结果3："</span> + i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor);</span><br><span class="line">CompletableFuture&lt;Void&gt; allOf = CompletableFuture.allOf(future1, future2, future3);</span><br><span class="line">allOf.get();</span><br><span class="line"></span><br><span class="line"><span class="comment">//CompletableFuture&lt;Object&gt; anyOf = CompletableFuture.anyOf(future1, future2, future3);</span></span><br><span class="line"><span class="comment">//System.out.println("end"+anyOf.get());</span></span><br></pre></td></tr></table></figure>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>代码在product服务的SkuInfoServiceImpl类中</p>
<h3 id="认证服务"><a href="#认证服务" class="headerlink" title="认证服务"></a>认证服务</h3><h4 id="简单登录逻辑"><a href="#简单登录逻辑" class="headerlink" title="简单登录逻辑"></a>简单登录逻辑</h4><h5 id="验证码-令牌机制"><a href="#验证码-令牌机制" class="headerlink" title="验证码(令牌机制)"></a>验证码(令牌机制)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/sms/sendCode"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">sendCode</span><span class="params">(@RequestParam(<span class="string">"phone"</span>)</span> String phone) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、接口防刷</span></span><br><span class="line">    String redisCode = stringRedisTemplate.opsForValue().get(AuthServerConstant.SMS_CODE_CACHE_PREFIX + phone);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(redisCode)) &#123;</span><br><span class="line">        <span class="comment">//活动存入redis的时间，用当前时间减去存入redis的时间，判断用户手机号是否在60s内发送验证码</span></span><br><span class="line">        <span class="keyword">long</span> currentTime = Long.parseLong(redisCode.split(<span class="string">"_"</span>)[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (System.currentTimeMillis() - currentTime &lt; <span class="number">60000</span>) &#123;</span><br><span class="line">            <span class="comment">//60s内不能再发</span></span><br><span class="line">            <span class="keyword">return</span> R.error(BizCodeEnum.SMS_CODE_EXCEPTION.getCode(),BizCodeEnum.SMS_CODE_EXCEPTION.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、验证码的再次效验 redis.存key-phone,value-code</span></span><br><span class="line">    <span class="keyword">int</span> code = (<span class="keyword">int</span>) ((Math.random() * <span class="number">9</span> + <span class="number">1</span>) * <span class="number">100000</span>);</span><br><span class="line">    String codeNum = String.valueOf(code);</span><br><span class="line">    String redisStorage = codeNum + <span class="string">"_"</span> + System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存入redis，防止同一个手机号在60秒内再次发送验证码</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(AuthServerConstant.SMS_CODE_CACHE_PREFIX+phone,</span><br><span class="line">                                          redisStorage,<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这边是测试所以就不真正发了</span></span><br><span class="line">    <span class="comment">// 调用第三方接口发送</span></span><br><span class="line">    <span class="comment">//        thirdPartFeignService.sendCode(phone, codeNum);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">TODO:</span> 重定向携带数据：利用session原理，将数据放在session中。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">TODO:</span> 只要跳转到下一个页面取出这个数据以后，session里面的数据就会删掉</span></span><br><span class="line"><span class="comment">     * TODO：分布下session问题</span></span><br><span class="line"><span class="comment">     * RedirectAttributes：重定向也可以保留数据，不会丢失</span></span><br><span class="line"><span class="comment">     * 用户注册</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/register"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">register</span><span class="params">(@Valid UserRegisterVo vos, BindingResult result,</span></span></span><br><span class="line"><span class="function"><span class="params">                       RedirectAttributes attributes)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如果有错误回到注册页面</span></span><br><span class="line">    <span class="keyword">if</span> (result.hasErrors()) &#123;</span><br><span class="line">        Map&lt;String, String&gt; errors = result.getFieldErrors().stream().collect(Collectors.toMap(FieldError::getField, FieldError::getDefaultMessage));</span><br><span class="line">        attributes.addFlashAttribute(<span class="string">"errors"</span>,errors);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//效验出错回到注册页面</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:http://auth.gulimall.com/reg.html"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、效验验证码</span></span><br><span class="line">    String code = vos.getCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取存入Redis里的验证码</span></span><br><span class="line">    String redisCode = stringRedisTemplate.opsForValue().get(AuthServerConstant.SMS_CODE_CACHE_PREFIX + vos.getPhone());</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(redisCode)) &#123;</span><br><span class="line">        <span class="comment">//截取字符串</span></span><br><span class="line">        <span class="keyword">if</span> (code.equals(redisCode.split(<span class="string">"_"</span>)[<span class="number">0</span>])) &#123;<span class="comment">// 传入的验证码正确</span></span><br><span class="line">            <span class="comment">//删除验证码;令牌机制</span></span><br><span class="line">            stringRedisTemplate.delete(AuthServerConstant.SMS_CODE_CACHE_PREFIX+vos.getPhone());</span><br><span class="line">            <span class="comment">//验证码通过，真正注册，调用远程服务进行注册</span></span><br><span class="line">            R register = memberFeignService.register(vos);</span><br><span class="line">            <span class="keyword">if</span> (register.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//成功</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">"redirect:http://auth.gulimall.com/login.html"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//失败</span></span><br><span class="line">                Map&lt;String, String&gt; errors = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                errors.put(<span class="string">"msg"</span>, register.getData(<span class="string">"msg"</span>,<span class="keyword">new</span> TypeReference&lt;String&gt;()&#123;&#125;));</span><br><span class="line">                attributes.addFlashAttribute(<span class="string">"errors"</span>,errors);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"redirect:http://auth.gulimall.com/reg.html"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//效验出错回到注册页面</span></span><br><span class="line">            Map&lt;String, String&gt; errors = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            errors.put(<span class="string">"code"</span>,<span class="string">"验证码错误"</span>);</span><br><span class="line">            attributes.addFlashAttribute(<span class="string">"errors"</span>,errors);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:http://auth.gulimall.com/reg.html"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//效验出错回到注册页面</span></span><br><span class="line">        Map&lt;String, String&gt; errors = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        errors.put(<span class="string">"code"</span>,<span class="string">"验证码错误"</span>);</span><br><span class="line">        attributes.addFlashAttribute(<span class="string">"errors"</span>,errors);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:http://auth.gulimall.com/reg.html"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="社交登录"><a href="#社交登录" class="headerlink" title="社交登录"></a>社交登录</h4><blockquote>
<p>使用第三方账号登录</p>
<p>通过访问令牌，只能访问获得公共的信息</p>
</blockquote>
<p>使用OAuth2.0原理图</p>
<p><img alt="22" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230207210459.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.用户点击社交登录</span></span><br><span class="line"><span class="comment">// 2.跳转到微博授权页面</span></span><br><span class="line"><span class="comment">// 3.微博返回授权页面(code在这边返回)</span></span><br><span class="line"><span class="comment">// 4.用户输入账号密码授权</span></span><br><span class="line"><span class="comment">// 5.跳转到微博进行登录</span></span><br><span class="line"><span class="comment">// 6.微博远程登录成功,返回会获得code,然后用code可以换取token(这里对应图中的第四步)</span></span><br><span class="line"><span class="comment">// 7.本地服务登录：查看是否是第一次登录(是否有账号),若没账号,还要走注册流程(在memberFeignService.oauthLogin(socialUser)中)</span></span><br><span class="line"><span class="comment">// 8.返回登录成功页面(到首页去？)</span></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/oauth2.0/weibo/success"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">weibo</span><span class="params">(@RequestParam(<span class="string">"code"</span>)</span> String code, HttpSession session) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">"client_id"</span>,<span class="string">"2077705774"</span>);</span><br><span class="line">    map.put(<span class="string">"client_secret"</span>,<span class="string">"40af02bd1c7e435ba6a6e9cd3bf799fd"</span>);</span><br><span class="line">    map.put(<span class="string">"grant_type"</span>,<span class="string">"authorization_code"</span>);</span><br><span class="line">    map.put(<span class="string">"redirect_uri"</span>,<span class="string">"http://auth.gulimall.com/oauth2.0/weibo/success"</span>);</span><br><span class="line">    map.put(<span class="string">"code"</span>,code);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、根据用户授权返回的code换取access_token</span></span><br><span class="line">    HttpResponse response = HttpUtils.doPost(<span class="string">"https://api.weibo.com"</span>, <span class="string">"/oauth2/access_token"</span>, <span class="string">"post"</span>, <span class="keyword">new</span> HashMap&lt;&gt;(), map, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、处理</span></span><br><span class="line">    <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="comment">//获取到了access_token,转为通用社交登录对象</span></span><br><span class="line">        String json = EntityUtils.toString(response.getEntity());</span><br><span class="line">        <span class="comment">//String json = JSON.toJSONString(response.getEntity());</span></span><br><span class="line">        SocialUser socialUser = JSON.parseObject(json, SocialUser.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//知道了哪个社交用户</span></span><br><span class="line">        <span class="comment">//1）、当前用户如果是第一次进网站，自动注册进来（为当前社交用户生成一个会员信息，以后这个社交账号就对应指定的会员）</span></span><br><span class="line">        <span class="comment">//登录或者注册这个社交用户</span></span><br><span class="line">        System.out.println(socialUser.getAccess_token());</span><br><span class="line">        <span class="comment">//调用远程服务</span></span><br><span class="line">        R oauthLogin = memberFeignService.oauthLogin(socialUser);</span><br><span class="line">        <span class="keyword">if</span> (oauthLogin.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">            MemberResponseVo data = oauthLogin.getData(<span class="string">"data"</span>, <span class="keyword">new</span> TypeReference&lt;MemberResponseVo&gt;() &#123;&#125;);</span><br><span class="line">            log.info(<span class="string">"登录成功：用户信息：&#123;&#125;"</span>,data.toString());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//1、第一次使用session，命令浏览器保存卡号，JSESSIONID这个cookie</span></span><br><span class="line">            <span class="comment">//以后浏览器访问哪个网站就会带上这个网站的cookie</span></span><br><span class="line">            <span class="comment">//TODO 1、默认发的令牌。当前域（解决子域session共享问题）</span></span><br><span class="line">            <span class="comment">//TODO 2、使用JSON的序列化方式来序列化对象到Redis中</span></span><br><span class="line">            session.setAttribute(LOGIN_USER,data);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2、登录成功跳回首页</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:http://gulimall.com"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:http://auth.gulimall.com/login.html"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:http://auth.gulimall.com/login.html"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="分布式Session"><a href="#分布式Session" class="headerlink" title="==分布式Session=="></a>==分布式Session==</h4><p><img alt="23" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230207223539.png"></p>
<p>==问题：session只能用于一台机器，对于不同机器，不同服务，不同域名都不能共享==</p>
<h5 id="方案1-session复制"><a href="#方案1-session复制" class="headerlink" title="方案1-session复制"></a>方案1-session复制</h5><p>小型系统可以考虑，大型系统同步代价太高</p>
<p><img alt="24" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208140252.png"></p>
<h5 id="方案2-客户端存储"><a href="#方案2-客户端存储" class="headerlink" title="方案2-客户端存储"></a>方案2-客户端存储</h5><p>不安全，不推荐</p>
<p><img alt="25" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208140505.png"></p>
<h5 id="方案3-使用hash一致性"><a href="#方案3-使用hash一致性" class="headerlink" title="方案3-使用hash一致性"></a>方案3-使用hash一致性</h5><p>问题不是很大，该方案也常用</p>
<p><img alt="26" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208140648.png"></p>
<h5 id="方案4-统一存储"><a href="#方案4-统一存储" class="headerlink" title="方案4-统一存储"></a>方案4-统一存储</h5><p><img alt="27" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208140845.png"></p>
<h5 id="使用SpringSession的最终方案"><a href="#使用SpringSession的最终方案" class="headerlink" title="==使用SpringSession的最终方案=="></a>==使用SpringSession的最终方案==</h5><h6 id="原理图"><a href="#原理图" class="headerlink" title="原理图"></a>原理图</h6><p><img alt="28" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208141949.png"></p>
<p>每次将session存入redis，取得时候不要取出(auth.gulimall.com)这样的域名，而是取出(.gulimall.com)这样的域名，这样所有其他子域名下的服务拿到session也能认证成功。</p>
<h6 id="导入依赖-1"><a href="#导入依赖-1" class="headerlink" title="导入依赖"></a>导入依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 整合springsession --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="yml配置"><a href="#yml配置" class="headerlink" title="yml配置"></a>yml配置</h6><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">    session:</span></span><br><span class="line"><span class="attr">        store-type:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>
<h6 id="配置类的注解"><a href="#配置类的注解" class="headerlink" title="配置类的注解"></a>配置类的注解</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@EnableRedisHttpSession     //整合Redis作为session存储</span><br><span class="line">public class GulimallAuthServerApplication &#123;&#125;</span><br></pre></td></tr></table></figure>
<h6 id="存入redis"><a href="#存入redis" class="headerlink" title="==存入redis=="></a>==存入redis==</h6><p>==注意别忘了pojo要想存入redis，必须实现序列化接口(因为对象在内存中，要想存到远程的redis中，就必须转化为二进制流通过网络传输到redis服务器)或使用json序列化传输==</p>
<p>使用序列化接口方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MemberResponseVo data = oauthLogin.getData(<span class="string">"data"</span>, <span class="keyword">new</span> TypeReference&lt;MemberResponseVo&gt;() &#123;&#125;);</span><br><span class="line">log.info(<span class="string">"登录成功：用户信息：&#123;&#125;"</span>,data.toString());</span><br><span class="line"></span><br><span class="line"><span class="comment">//1、第一次使用session，命令浏览器保存卡号，JSESSIONID这个cookie</span></span><br><span class="line"><span class="comment">//以后浏览器访问哪个网站就会带上这个网站的cookie</span></span><br><span class="line"><span class="comment">//TODO 1、默认发的令牌。当前域（解决子域session共享问题）</span></span><br><span class="line"><span class="comment">//TODO 2、使用JSON的序列化方式来序列化对象到Redis中</span></span><br><span class="line">session.setAttribute(LOGIN_USER,data);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberResponseVo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>使用json序列化：</p>
<p>需要配置序列化器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GulimallSessionConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现子域session共享的问题</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CookieSerializer <span class="title">cookieSerializer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultCookieSerializer cookieSerializer = <span class="keyword">new</span> DefaultCookieSerializer();</span><br><span class="line">        <span class="comment">//放大作用域</span></span><br><span class="line">        cookieSerializer.setDomainName(<span class="string">"gulimall.com"</span>);</span><br><span class="line">        cookieSerializer.setCookieName(<span class="string">"GULISESSION"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cookieSerializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// json-&gt;redis的序列化器,这样就不需要每个类都要继承序列化接口类了</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisSerializer&lt;Object&gt; <span class="title">springSessionDefaultRedisSerializer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GenericJackson2JsonRedisSerializer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="实现子域session共享的问题"><a href="#实现子域session共享的问题" class="headerlink" title="==实现子域session共享的问题=="></a>==实现子域session共享的问题==</h6><p>配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GulimallSessionConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现子域session共享的问题</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CookieSerializer <span class="title">cookieSerializer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultCookieSerializer cookieSerializer = <span class="keyword">new</span> DefaultCookieSerializer();</span><br><span class="line">        <span class="comment">//放大作用域</span></span><br><span class="line">        cookieSerializer.setDomainName(<span class="string">"gulimall.com"</span>);</span><br><span class="line">        cookieSerializer.setCookieName(<span class="string">"GULISESSION"</span>);<span class="comment">// 名字应该无所谓</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cookieSerializer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="SpringSession核心原理"><a href="#SpringSession核心原理" class="headerlink" title="==SpringSession核心原理=="></a>==SpringSession核心原理==</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.@EnableRedisHttpSession导入RedisHttpSessionConfiguration配置</span></span><br><span class="line"><span class="code">      1、给容器中添加了一个组件</span></span><br><span class="line"><span class="code">          SessionRepository-》RedisOperationsSessionRepository：Redis操作session，session的增删改查封装类</span></span><br><span class="line"><span class="code">      2.SessionRepositoryFilter-&gt;Filter:每个请求过来都必须经过filter</span></span><br><span class="line"><span class="code">          2.1创建的时候，就自动从容器中获取到了SessionRepository</span></span><br><span class="line"><span class="code">          2.2原生的request和response对象在里面经过包装变成SessionRepositoryRequestWrapper和SessionRepositoryResponseWrapper(装饰者模式)</span></span><br><span class="line"><span class="code">          2.3我们获取session,通常使用request.getSession(),这里就实际上调用了SessionRepositoryRequestWrapper.getSession()方法</span></span><br></pre></td></tr></table></figure>
<p><img alt="29" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208150723.png"></p>
<h4 id="单点登录"><a href="#单点登录" class="headerlink" title="单点登录"></a>单点登录</h4><blockquote>
<p>SSO(Single Sign On) 一处登陆、处处可用</p>
<p>适用于多系统(不同的父域名)</p>
</blockquote>
<h3 id="购物车功能"><a href="#购物车功能" class="headerlink" title="购物车功能"></a>购物车功能</h3><h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p>电商购物车<br>    存储<br>        1）以用户id为key<br>        2）商品id为field<br>        3）商品数量为value<br>    操作<br>        添加商品：hset cart:1001 10088 1<br>        增加数量：hincrby cart:1001 10088 1<br>        商品总数：hlen cart:1001<br>        删除商品：hdel cart:1001 10088<br>        获取购物车所有商品：hgetall cart:1001</p>
<p><img alt="3" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208174708.png"></p>
<h4 id="业务需求"><a href="#业务需求" class="headerlink" title="==业务需求=="></a>==业务需求==</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">去购物车页面的请求</span><br><span class="line">浏览器有一个cookie:user-key 标识用户的身份，一个月过期</span><br><span class="line">如果第一次使用jd的购物车功能，都会给一个临时的用户身份:</span><br><span class="line">浏览器以后保存，每次访问都会带上这个cookie；</span><br><span class="line"></span><br><span class="line">登录：session有</span><br><span class="line">没登录：按照cookie里面带来user-key来做</span><br><span class="line">第一次，如果没有临时用户，自动创建一个临时用户</span><br></pre></td></tr></table></figure>
<p>==使用HandlerInterceptor+ThreadLocal实现拦截添加临时用户的功能==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CartInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;UserInfoTo&gt; toThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 目标方法执行之前</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        UserInfoTo userInfoTo = <span class="keyword">new</span> UserInfoTo();</span><br><span class="line"></span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line">        <span class="comment">//获得当前登录用户的信息</span></span><br><span class="line">        MemberResponseVo memberResponseVo = (MemberResponseVo) session.getAttribute(LOGIN_USER);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (memberResponseVo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//用户登录了</span></span><br><span class="line">            userInfoTo.setUserId(memberResponseVo.getId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Cookie[] cookies = request.getCookies();</span><br><span class="line">        <span class="keyword">if</span> (cookies != <span class="keyword">null</span> &amp;&amp; cookies.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">                <span class="comment">//user-key</span></span><br><span class="line">                String name = cookie.getName();</span><br><span class="line">                <span class="keyword">if</span> (name.equals(TEMP_USER_COOKIE_NAME)) &#123;</span><br><span class="line">                    userInfoTo.setUserKey(cookie.getValue());</span><br><span class="line">                    <span class="comment">//标记为已是临时用户</span></span><br><span class="line">                    userInfoTo.setTempUser(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果没有临时用户一定分配一个临时用户</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(userInfoTo.getUserKey())) &#123;</span><br><span class="line">            String uuid = UUID.randomUUID().toString();</span><br><span class="line">            userInfoTo.setUserKey(uuid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//目标方法执行之前</span></span><br><span class="line">        toThreadLocal.set(userInfoTo);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务执行之后，分配临时用户来浏览器保存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> modelAndView</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取当前用户的值</span></span><br><span class="line">        UserInfoTo userInfoTo = toThreadLocal.get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果没有临时用户一定保存一个临时用户</span></span><br><span class="line">        <span class="keyword">if</span> (!userInfoTo.getTempUser()) &#123;</span><br><span class="line">            <span class="comment">//创建一个cookie</span></span><br><span class="line">            Cookie cookie = <span class="keyword">new</span> Cookie(TEMP_USER_COOKIE_NAME, userInfoTo.getUserKey());</span><br><span class="line">            <span class="comment">//扩大作用域</span></span><br><span class="line">            cookie.setDomain(<span class="string">"gulimall.com"</span>);</span><br><span class="line">            <span class="comment">//设置过期时间</span></span><br><span class="line">            cookie.setMaxAge(TEMP_USER_COOKIE_TIMEOUT);</span><br><span class="line">            response.addCookie(cookie);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="购物车redis代码"><a href="#购物车redis代码" class="headerlink" title="购物车redis代码"></a>购物车redis代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//绑定指定的key操作Redis</span></span><br><span class="line">BoundHashOperations&lt;String, Object, Object&gt; operations = stringRedisTemplate.boundHashOps(cartKey);</span><br><span class="line">operations.get(skuId.toString());</span><br><span class="line">operations.put(skuId.toString(), cartItemJson);</span><br><span class="line">operations.delete(skuId.toString());</span><br></pre></td></tr></table></figure>
<h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><h4 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h4><blockquote>
<p>docker pull rabbitmq:managment</p>
<p>启动</p>
<p>docker run -d —name rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 25672:25672 -p 15671:15671 -p 15672:15672 rabbitmq:management</p>
<p>tip:没有的话，docker run 会先安装在启动</p>
<p>解释</p>
<blockquote>
<p>4369, 25672 (Erlang发现&amp;集群端口)</p>
<p>5672, 5671 (AMQP端口)</p>
<p>15672 (web管理后台端口)</p>
<p>61613, 61614 (STOMP协议端口)</p>
<p>1883, 8883 (MQTT协议端口)</p>
<p><a href="https://www.rabbitmq.com/networking.html" target="_blank" rel="noopener">https://www.rabbitmq.com/networking.html</a></p>
</blockquote>
<p>默认账号  guest/guest</p>
</blockquote>
<h4 id="MQ优势"><a href="#MQ优势" class="headerlink" title="MQ优势"></a>MQ优势</h4><p>​    应用解耦</p>
<blockquote>
<p>如若订单系统调用库存系统的接口改了，那么订单系统也要跟着改，不方便维护</p>
</blockquote>
<p><img alt="1" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208203444.png"></p>
<p>​    异步提速</p>
<p><img alt="2" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208203447.png"></p>
<p>​    削峰填谷</p>
<p><img alt="3" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208203450.png"></p>
<h4 id="消息队列两大规范"><a href="#消息队列两大规范" class="headerlink" title="消息队列两大规范"></a>消息队列两大规范</h4><p>JMS，ActiveMQ实现</p>
<p>AMQP，RabbitMQ实现</p>
<p><img alt="30" data-src="E:\desktop\自学\MyNote\项目\谷粒商城\images\30.png"></p>
<h4 id="基本组件图-概念图"><a href="#基本组件图-概念图" class="headerlink" title="基本组件图(概念图)"></a>基本组件图(概念图)</h4><blockquote>
<p>这是比较整体的图，具体的来说有好几种模式(工作模式，路由模式(Direct：定向)，发布/订阅模式(Fanout：广播)，Topics主题模式(Topic：通配符))</p>
</blockquote>
<p><img alt="img" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230208210335.png"></p>
<p>其中MQ就充当了Broker消息代理的角色</p>
<p>route-key路由键结合交换机的类型(direct,fanout,topic)决定消息发给哪些队列，==注意和队列名称和交换机名称没有关系==</p>
<p>VHost</p>
<blockquote>
<p>虚拟主机，表示一批交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加密环境的独立服务器域。每个 vhost 本质上就是一个 mini 版的 RabbitMQ 服务器，拥有自己的队列、交换器、绑定和权限机制。vhost 是 AMQP 概念的基础，必须在连接时指定，RabbitMQ 默认的 vhost 是 / 。</p>
<p>比如java和PHP可以隔离出两个VHost，一个崩溃了不会影响另一个；或者生产和测试可以隔离出两个VHost </p>
</blockquote>
<h4 id="SpringBoot整合-2"><a href="#SpringBoot整合-2" class="headerlink" title="SpringBoot整合"></a>SpringBoot整合</h4><h5 id="导入依赖-2"><a href="#导入依赖-2" class="headerlink" title="导入依赖"></a>导入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="AmqpAdmin用于增删改查队列、交换机及其绑定关系等"><a href="#AmqpAdmin用于增删改查队列、交换机及其绑定关系等" class="headerlink" title="AmqpAdmin用于增删改查队列、交换机及其绑定关系等"></a>AmqpAdmin用于增删改查队列、交换机及其绑定关系等</h5><blockquote>
<p>结合web图形界面更直观</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// DirectExchange(String name, boolean durable, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line">    <span class="comment">// 名称,持久化,是否自动删除,额外参数</span></span><br><span class="line">    admin.declareExchange(<span class="keyword">new</span> DirectExchange(<span class="string">"hello-java-exchange"</span>,<span class="keyword">true</span>,<span class="keyword">false</span>));</span><br><span class="line">    log.info(<span class="string">"Exchange:&#123;&#125;创建成功"</span>,<span class="string">"hello-java-exchange"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Queue(String name, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line">    <span class="comment">// 名称,是否持久化,是否排他(只能被一个人连接),是否自动删除,额外参数</span></span><br><span class="line">    admin.declareQueue(<span class="keyword">new</span> Queue(<span class="string">"hello-java-queue"</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>));</span><br><span class="line">    log.info(<span class="string">"Queue:&#123;&#125;创建成功"</span>,<span class="string">"hello-java-queue"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createBinding</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        Binding(String destination, Binding.DestinationType destinationType, String exchange, String routingKey,</span></span><br><span class="line"><span class="comment">//                Map&lt;String, Object&gt; arguments)</span></span><br><span class="line">    <span class="comment">// 目的地，目的地类型(交换机或队列)，交换机，路由键</span></span><br><span class="line">    admin.declareBinding(<span class="keyword">new</span> Binding(<span class="string">"hello-java-queue"</span>,Binding.DestinationType.QUEUE,</span><br><span class="line">            <span class="string">"hello-java-exchange"</span>,</span><br><span class="line">            <span class="string">"hello.java"</span>,<span class="keyword">null</span>));</span><br><span class="line">    log.info(<span class="string">"Binding:&#123;&#125;创建成功"</span>,<span class="string">"hello-java-binding"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="RabbitTemplate用于发送消息"><a href="#RabbitTemplate用于发送消息" class="headerlink" title="RabbitTemplate用于发送消息"></a>RabbitTemplate用于发送消息</h5><p>如果要发送对象，就必须实现序列化接口</p>
<p>或者转为json发送(需要往容器中注入rabbitmq的json转换器 Jackson2JsonMessageConverter)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    OrderReturnReasonEntity reasonEntity = <span class="keyword">new</span> OrderReturnReasonEntity();</span><br><span class="line">    reasonEntity.setId(<span class="number">1L</span>);</span><br><span class="line">    reasonEntity.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">    reasonEntity.setName(<span class="string">"reason"</span>);</span><br><span class="line">    reasonEntity.setStatus(<span class="number">1</span>);</span><br><span class="line">    reasonEntity.setSort(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 如果要发送对象，就必须实现序列化接口或者转为json发送</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">"hello-java-exchange"</span>,<span class="string">"hello.java"</span>,reasonEntity);</span><br><span class="line">    log.info(<span class="string">"消息:&#123;&#125;发送完成"</span>,<span class="string">"hello world"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="RabbitListner用于监听信息"><a href="#RabbitListner用于监听信息" class="headerlink" title="@RabbitListner用于监听信息"></a>@RabbitListner用于监听信息</h5><blockquote>
<p>例如接收如上RabbitTemplate发送的信息</p>
<p>@RabbitHandler也常用，不过只能用于方法；@RabbitListner可以用于方法和类。但是@RabbitHandler标注能够方便标注重载方法(区分不同的消息)，@RabbitListner此时就用来标注到类上，表示接收哪个队列的消息</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span>(<span class="string">"orderItemService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderItemServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">OrderItemDao</span>, <span class="title">OrderItemEntity</span>&gt; <span class="keyword">implements</span> <span class="title">OrderItemService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = &#123;<span class="string">"hello-java-queue"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">revieveMessage</span><span class="params">(Message message,</span></span></span><br><span class="line"><span class="function"><span class="params">                               OrderReturnReasonEntity content,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Channel channel)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//拿到主体内容</span></span><br><span class="line">        <span class="keyword">byte</span>[] body = message.getBody();</span><br><span class="line">        <span class="comment">//拿到的消息头属性信息</span></span><br><span class="line">        MessageProperties messageProperties = message.getMessageProperties();</span><br><span class="line">        System.out.println(<span class="string">"接受到的消息...内容"</span> + message + <span class="string">"===内容："</span> + content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="消息确认机制"><a href="#消息确认机制" class="headerlink" title="消息确认机制"></a>消息确认机制</h4><blockquote>
<p>==保证消息不丢失，可靠抵达，虽然可以使用事务消息，但是性能下降250倍，为此引入确认机制==</p>
</blockquote>
<p>==分别从服务端和消费端实现确认机制==</p>
<p><img alt="32" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230210170128.png"></p>
<h5 id="ConfirmCallback"><a href="#ConfirmCallback" class="headerlink" title="ConfirmCallback"></a>ConfirmCallback</h5><p>只要消息抵达Broker就ack=true</p>
<p><img alt="33" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230210170520.png"></p>
<h5 id="ReturnCallback"><a href="#ReturnCallback" class="headerlink" title="ReturnCallback"></a>ReturnCallback</h5><p>==只要消息没有投递给指定的队列，就触发这个失败回调==</p>
<p><img alt="34" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230210170517.png"></p>
<h5 id="Ack消息确认机制"><a href="#Ack消息确认机制" class="headerlink" title="==Ack消息确认机制=="></a>==Ack消息确认机制==</h5><p><img alt="35" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/20230210170513.png"></p>
<h5 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h5><p>yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">    rabbitmq:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.108</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">5672</span></span><br><span class="line"><span class="attr">        virtual-host:</span> <span class="string">/</span></span><br><span class="line">        <span class="comment"># 开启发送端消息抵达Broker确认</span></span><br><span class="line"><span class="attr">        publisher-confirms:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 开启发送端消息抵达Queue确认</span></span><br><span class="line"><span class="attr">        publisher-returns:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 只要消息抵达Queue，就会异步发送优先回调returnfirm</span></span><br><span class="line"><span class="attr">        template:</span></span><br><span class="line"><span class="attr">          mandatory:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 手动ack消息，不使用默认的消费端确认</span></span><br><span class="line"><span class="attr">        listener:</span></span><br><span class="line"><span class="attr">          simple:</span></span><br><span class="line"><span class="attr">            acknowledge-mode:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure>
<p>服务端确认需要的配置config.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRabbitConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageConverter <span class="title">messageConverter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Jackson2JsonMessageConverter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定制RabbitTemplate</span></span><br><span class="line"><span class="comment">     * 1、服务收到消息就会回调</span></span><br><span class="line"><span class="comment">     *      1、spring.rabbitmq.publisher-confirms: true</span></span><br><span class="line"><span class="comment">     *      2、设置确认回调</span></span><br><span class="line"><span class="comment">     * 2、消息正确抵达队列就会进行回调</span></span><br><span class="line"><span class="comment">     *      1、spring.rabbitmq.publisher-returns: true</span></span><br><span class="line"><span class="comment">     *         spring.rabbitmq.template.mandatory: true</span></span><br><span class="line"><span class="comment">     *      2、设置确认回调ReturnCallback</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 3、消费端确认(保证每个消息都被正确消费，此时才可以broker删除这个消息)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// @PostConstruct  //MyRabbitConfig对象创建完成以后，执行这个方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initRabbitTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 1、只要消息抵达Broker就ack=true</span></span><br><span class="line"><span class="comment">         * correlationData：当前消息的唯一关联数据(这个是消息的唯一id)</span></span><br><span class="line"><span class="comment">         * ack：消息是否成功收到</span></span><br><span class="line"><span class="comment">         * cause：失败的原因</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//设置确认回调</span></span><br><span class="line">        rabbitTemplate.setConfirmCallback((correlationData,ack,cause) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"confirm...correlationData["</span>+correlationData+<span class="string">"]==&gt;ack:["</span>+ack+<span class="string">"]==&gt;cause:["</span>+cause+<span class="string">"]"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只要消息没有投递给指定的队列，就触发这个失败回调</span></span><br><span class="line"><span class="comment">         * message：投递失败的消息详细信息</span></span><br><span class="line"><span class="comment">         * replyCode：回复的状态码</span></span><br><span class="line"><span class="comment">         * replyText：回复的文本内容</span></span><br><span class="line"><span class="comment">         * exchange：当时这个消息发给哪个交换机</span></span><br><span class="line"><span class="comment">         * routingKey：当时这个消息用哪个路邮键</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rabbitTemplate.setReturnCallback((message,replyCode,replyText,exchange,routingKey) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"Fail Message["</span>+message+<span class="string">"]==&gt;replyCode["</span>+replyCode+<span class="string">"]"</span> +</span><br><span class="line">                    <span class="string">"==&gt;replyText["</span>+replyText+<span class="string">"]==&gt;exchange["</span>+exchange+<span class="string">"]==&gt;routingKey["</span>+routingKey+<span class="string">"]"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ack消费者确认机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitHandler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">revieveMessage</span><span class="params">(Message message,</span></span></span><br><span class="line"><span class="function"><span class="params">                           OrderReturnReasonEntity content,</span></span></span><br><span class="line"><span class="function"><span class="params">                           Channel channel)</span></span>&#123;</span><br><span class="line">    <span class="comment">//拿到主体内容</span></span><br><span class="line">    <span class="keyword">byte</span>[] body = message.getBody();</span><br><span class="line">    <span class="comment">//拿到的消息头属性信息</span></span><br><span class="line">    MessageProperties messageProperties = message.getMessageProperties();</span><br><span class="line">    System.out.println(<span class="string">"接受到的消息...内容"</span> + <span class="keyword">new</span> String(body) + <span class="string">"===内容："</span> + content);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deliveryTag在该通道内从1开始计数   表示消息唯一标识</span></span><br><span class="line">    <span class="keyword">long</span> deliveryTag = message.getMessageProperties().getDeliveryTag();</span><br><span class="line">    <span class="comment">// 签收消息</span></span><br><span class="line">    <span class="comment">// multiple=false(挨个签收)</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        channel.basicAck(deliveryTag,<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 表示消息唯一标识,是否批量,拒绝后是否发挥服务器重新入队</span></span><br><span class="line">        <span class="comment">// channel.basicNack(deliveryTag,false,true);</span></span><br><span class="line">        <span class="comment">//            // 表示消息唯一标识,拒绝后是否发挥服务器重新入队</span></span><br><span class="line">        <span class="comment">// channel.basicReject(deliveryTag,true);</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// 网络中断</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="延时队列"><a href="#延时队列" class="headerlink" title="延时队列"></a>延时队列</h4><h5 id="死信路由-DLX"><a href="#死信路由-DLX" class="headerlink" title="死信路由(DLX)"></a>死信路由(DLX)</h5><p>一个消息在满足如下条件下，会进死信路由，记住这里是路由而不是队列， 一个路由可以对应很多队列。（什么是死信）</p>
<p>成为死信的情况：</p>
<p>​        1.一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。（basic.reject/ basic.nack）requeue=false<br>​        2.上面的消息的TTL到了，消息过期了。<br>​        3.队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上</p>
<p>Dead Letter Exchange其实就是一种普通的exchange，和创建其他exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有 消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。</p>
<p>我们既可以控制消息在一段时间后变成死信，又可以控制变成死信的消息 被路由到某一个指定的交换机，结合二者，其实就可以实现一个延时队列</p>
<p>手动ack&amp;异常消息统一放在一个队列处理建议的两种方式<br>        catch异常后，手动发送到指定队列，然后使用channel给rabbitmq确认消息已消费<br>        给Queue绑定死信队列，使用nack（requque为false）确认消息消费失败</p>
<h5 id="场景-1"><a href="#场景-1" class="headerlink" title="场景"></a>场景</h5><p><img alt="39" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/39.png"></p>
<h5 id="定时任务时效性"><a href="#定时任务时效性" class="headerlink" title="定时任务时效性"></a>定时任务时效性</h5><p><img alt="40" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/40.png"></p>
<h4 id="订单业务—使用MQ实现最终一致性的分布式事务"><a href="#订单业务—使用MQ实现最终一致性的分布式事务" class="headerlink" title="==订单业务—使用MQ实现最终一致性的分布式事务=="></a>==订单业务—使用MQ实现最终一致性的分布式事务==</h4><p>==遵循一个服务一个交换机的原则==，延时队列设计如下图。</p>
<p><img alt="41" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/41.png"></p>
<h5 id="整体消息队列架构"><a href="#整体消息队列架构" class="headerlink" title="整体消息队列架构"></a>整体消息队列架构</h5><p><img alt="消息队列流程" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/消息队列流程.jpg"></p>
<h5 id="创建延时队列"><a href="#创建延时队列" class="headerlink" title="创建延时队列"></a>创建延时队列</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Queue <span class="title">orderDelayQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Queue(String name,  队列名字</span></span><br><span class="line"><span class="comment">        boolean durable,  是否持久化</span></span><br><span class="line"><span class="comment">        boolean exclusive,  是否排他</span></span><br><span class="line"><span class="comment">        boolean autoDelete, 是否自动删除</span></span><br><span class="line"><span class="comment">        Map&lt;String, Object&gt; arguments) 属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    HashMap&lt;String, Object&gt; arguments = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    arguments.put(<span class="string">"x-dead-letter-exchange"</span>, <span class="string">"order-event-exchange"</span>);<span class="comment">// 死信之后发给那个交换机</span></span><br><span class="line">    arguments.put(<span class="string">"x-dead-letter-routing-key"</span>, <span class="string">"order.release.order"</span>);<span class="comment">// 死信之后的routing-key</span></span><br><span class="line">    arguments.put(<span class="string">"x-message-ttl"</span>, <span class="number">60000</span>); <span class="comment">// 消息过期时间 1分钟</span></span><br><span class="line">    Queue queue = <span class="keyword">new</span> Queue(<span class="string">"order.delay.queue"</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, arguments);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建死信交换机"><a href="#创建死信交换机" class="headerlink" title="创建死信交换机"></a>创建死信交换机</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TopicExchange</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Exchange <span class="title">orderEventExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *   String name,</span></span><br><span class="line"><span class="comment">     *   boolean durable,</span></span><br><span class="line"><span class="comment">     *   boolean autoDelete,</span></span><br><span class="line"><span class="comment">     *   Map&lt;String, Object&gt; arguments</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TopicExchange(<span class="string">"order-event-exchange"</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建目的地交换机"><a href="#创建目的地交换机" class="headerlink" title="创建目的地交换机"></a>创建目的地交换机</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Queue <span class="title">orderReleaseQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Queue queue = <span class="keyword">new</span> Queue(<span class="string">"order.release.order.queue"</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="绑定关系"><a href="#绑定关系" class="headerlink" title="绑定关系"></a>绑定关系</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Binding <span class="title">orderCreateBinding</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * String destination, 目的地（队列名或者交换机名字）</span></span><br><span class="line"><span class="comment">     * DestinationType destinationType, 目的地类型（Queue、Exhcange）</span></span><br><span class="line"><span class="comment">     * String exchange,</span></span><br><span class="line"><span class="comment">     * String routingKey,</span></span><br><span class="line"><span class="comment">     * Map&lt;String, Object&gt; arguments</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Binding(<span class="string">"order.delay.queue"</span>,</span><br><span class="line">            Binding.DestinationType.QUEUE,</span><br><span class="line">            <span class="string">"order-event-exchange"</span>,</span><br><span class="line">            <span class="string">"order.create.order"</span>,</span><br><span class="line">            <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Binding <span class="title">orderReleaseBinding</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Binding(<span class="string">"order.release.order.queue"</span>,</span><br><span class="line">            Binding.DestinationType.QUEUE,</span><br><span class="line">            <span class="string">"order-event-exchange"</span>,</span><br><span class="line">            <span class="string">"order.release.order"</span>,</span><br><span class="line">            <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="发消息"><a href="#发消息" class="headerlink" title="发消息"></a>发消息</h5><p>订单创建成功往延时队列中发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TODO 订单创建成功，发送消息给MQ</span></span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">"order-event-exchange"</span>,<span class="string">"order.create.order"</span>,order.getOrder());</span><br><span class="line"><span class="comment">// 这里不需要有消费者,过期之后让消费者取消订单就行</span></span><br></pre></td></tr></table></figure>
<h5 id="监听过期消息"><a href="#监听过期消息" class="headerlink" title="监听过期消息"></a>监听过期消息</h5><p>在延迟队列中的消息，相当于有个定时器，到期之后，能够监听到，就可以调用方法来取消订单。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener</span>(queues = <span class="string">"order.release.order.queue"</span>)</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderCloseListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listener</span><span class="params">(OrderEntity orderEntity, Channel channel, Message message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"收到过期的订单信息，准备关闭订单"</span> + orderEntity.getOrderSn());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            orderService.closeOrder(orderEntity);</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            channel.basicReject(message.getMessageProperties().getDeliveryTag(),<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="MQ的几个可靠性问题"><a href="#MQ的几个可靠性问题" class="headerlink" title="MQ的几个可靠性问题"></a>MQ的几个可靠性问题</h4><h5 id="消息丢失"><a href="#消息丢失" class="headerlink" title="消息丢失"></a>消息丢失</h5><p>没抵达broker(MQ服务器)：保证每个消息一定会发出去，做好日志(存到mysql中)。定期扫描数据库，重新发送失败的消息</p>
<p>抵达了broker(MQ服务器)：使用publisher的消息确认机制</p>
<p><img alt="42" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/42.png"></p>
<h5 id="消息重复"><a href="#消息重复" class="headerlink" title="消息重复"></a>消息重复</h5><p><img alt="43" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/43.png"></p>
<h5 id="消息积压"><a href="#消息积压" class="headerlink" title="消息积压"></a>消息积压</h5><p><img alt="44" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/44.png"></p>
<h3 id="订单业务"><a href="#订单业务" class="headerlink" title="==订单业务=="></a>==订单业务==</h3><h4 id="幂等性"><a href="#幂等性" class="headerlink" title="==幂等性=="></a>==幂等性==</h4><blockquote>
<p><strong>接口幂等性就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的</strong></p>
</blockquote>
<p>进入订单确认页的时候存一份令牌</p>
<blockquote>
<p>order服务下的OrderServiceImpl</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为用户设置一个token，三十分钟过期时间（存在redis）</span></span><br><span class="line">String token = UUID.randomUUID().toString().replace(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line">redisTemplate.opsForValue().set(USER_ORDER_TOKEN_PREFIX+memberResponseVo.getId(),token,<span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">confirmVo.setOrderToken(token);</span><br></pre></td></tr></table></figure>
<p>提交订单的时候就要使用lua脚本原子性查，并且删除</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1、验证令牌是否合法【令牌的对比和删除必须保证原子性】</span></span><br><span class="line">String script = <span class="string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</span><br><span class="line">String orderToken = vo.getOrderToken();</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过lua脚本原子验证令牌和删除令牌</span></span><br><span class="line">Long result = redisTemplate.execute(<span class="keyword">new</span> DefaultRedisScript&lt;Long&gt;(script, Long.class),</span><br><span class="line">        Arrays.asList(USER_ORDER_TOKEN_PREFIX + memberResponseVo.getId()),</span><br><span class="line">        orderToken);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">0L</span>) &#123;</span><br><span class="line">    <span class="comment">//令牌验证失败</span></span><br><span class="line">    responseVo.setCode(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> responseVo;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//令牌验证成功</span></span><br></pre></td></tr></table></figure>
<h4 id="分布式事务"><a href="#分布式事务" class="headerlink" title="==分布式事务=="></a>==分布式事务==</h4><p>本地事务异常</p>
<p><img alt="38" data-src="https://blog-wd.oss-cn-shanghai.aliyuncs.com/项目笔记/谷粒商城/38.png"></p>
<h5 id="seata（2PC）"><a href="#seata（2PC）" class="headerlink" title="seata（2PC）"></a>seata（2PC）</h5><h6 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h6><p>1.给每个服务的数据库中加入undo_log表(具体内容从官网上查)</p>
<p>2.安装事务协调器seata(从Github下载)，并启动</p>
<p>3.导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>4.配置</p>
<p>注册中心配置—&gt;registry.conf</p>
<p>seata配置—&gt;file.conf</p>
<p>5.注入Seata代理数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySeataConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSourceProperties dataSourceProperties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">(DataSourceProperties dataSourceProperties)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        HikariDataSource dataSource = dataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(dataSourceProperties.getName())) &#123;</span><br><span class="line">            dataSource.setPoolName(dataSourceProperties.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProxy(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6.(==这个0.xx才有，1.2之后都没有了==)每个微服务都需要导入file.conf和registry.conf，还要在file.conf修改</p>
<blockquote>
<p>   service下的vgroup_mapping修改成vgroup_mapping.微服务名称-fescar-service-group = “default”</p>
</blockquote>
<p>7.给大事务方法加上@GlobalTransactional，小事务加上@Transactional就行</p>
<h6 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h6><p>AT模式(默认)，不适合高并发，不考虑2PC，也不考虑TCC模式，这样的是强一致性，很消耗性能</p>
<h5 id="高性能的实现方式"><a href="#高性能的实现方式" class="headerlink" title="==高性能的实现方式=="></a>==高性能的实现方式==</h5><p>这就是文档中的<strong>柔性事务+可靠消息+最终一致性方案</strong></p>
<p>使用MQ回滚，保证弱一致性-最终一致性</p>
<h4 id="业务分析"><a href="#业务分析" class="headerlink" title="业务分析"></a>业务分析</h4><p>库存解锁：就是防止后续付款的时候，库存没货了。所以在创建订单时就把库存锁定，后面付款时就肯定有库存。</p>
<h3 id="分布式原理"><a href="#分布式原理" class="headerlink" title="==分布式原理=="></a>==分布式原理==</h3><blockquote>
<p>  参考文档</p>
<p>  <a href="http://thesecretlivesofdata.com/raft/" target="_blank" rel="noopener">http://thesecretlivesofdata.com/raft/</a></p>
<p>  <a href="https://raft.github.io/" target="_blank" rel="noopener">https://raft.github.io/</a></p>
</blockquote>
<p>==C和A无法同时满足(一致性和可用性无法同时满足)，所以不存在CA系统，只有AP和CP系统==</p>
<p>ABC系统，A给C同步数据时，网线断了，那么此时A和B都是8，C还是7。如要满足可用性，那么读出来的数据是7，不满足一致性；如要满足一致性，读出来的数据是8，那么C就不能用。综上，一致性和可用性无法同时满足</p>

    </div>

    
    
    
        
      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/alex-next/tags/项目/" rel="tag"># 项目</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/alex-next/2022/10/18/面试题/MyBatis面试题/" rel="next" title="mybatis面试题">
                  <i class="fa fa-chevron-left"></i> mybatis面试题
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/alex-next/2022/10/30/面试题/JVM面试题/" rel="prev" title="JVM面试题">
                  JVM面试题 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    <div class="comments" id="gitalk-container"></div>
  

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础篇"><span class="nav-number">1.</span> <span class="nav-text">基础篇</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#项目背景"><span class="nav-number">1.1.</span> <span class="nav-text">项目背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式基础概念"><span class="nav-number">1.2.</span> <span class="nav-text">分布式基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#微服务"><span class="nav-number">1.2.1.</span> <span class="nav-text">微服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群-分布式-节点"><span class="nav-number">1.2.2.</span> <span class="nav-text">集群-分布式-节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#远程调用"><span class="nav-number">1.2.3.</span> <span class="nav-text">远程调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#负载均衡"><span class="nav-number">1.2.4.</span> <span class="nav-text">负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务注册-发现-amp-注册中心"><span class="nav-number">1.2.5.</span> <span class="nav-text">服务注册/发现&amp;注册中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置中心"><span class="nav-number">1.2.6.</span> <span class="nav-text">配置中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务熔断-amp-降级"><span class="nav-number">1.2.7.</span> <span class="nav-text">服务熔断&amp;降级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#API网关l"><span class="nav-number">1.2.8.</span> <span class="nav-text">API网关l</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境搭建"><span class="nav-number">1.3.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-搭建linux虚拟机"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.搭建linux虚拟机</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#vagrant安装"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">vagrant安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#自己使用的virtualbox安装"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">自己使用的virtualbox安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#扩容"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">扩容</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-安装docker"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.安装docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-docker安装mysql"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.docker安装mysql</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-docker安装redis"><span class="nav-number">1.3.4.</span> <span class="nav-text">4.docker安装redis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-安装开发环境"><span class="nav-number">1.3.5.</span> <span class="nav-text">5.安装开发环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-逆向生成代码"><span class="nav-number">1.3.6.</span> <span class="nav-text">6.逆向生成代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前端开发基础知识"><span class="nav-number">1.4.</span> <span class="nav-text">前端开发基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ES6"><span class="nav-number">1.4.1.</span> <span class="nav-text">ES6</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#map-reduce"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">==map== ==reduce==</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#promise"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">==promise==</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#模块化"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">模块化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#json-的key和value相同可以省略key"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">json 的key和value相同可以省略key</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Node-js"><span class="nav-number">1.4.2.</span> <span class="nav-text">Node.js</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Vue"><span class="nav-number">1.4.3.</span> <span class="nav-text">Vue</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#初步使用"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">初步使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#MVVM"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">MVVM</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#指令总结"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">指令总结</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#计算属性"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">==计算属性==</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#监听器"><span class="nav-number">1.4.3.5.</span> <span class="nav-text">==监听器==</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#过滤器"><span class="nav-number">1.4.3.6.</span> <span class="nav-text">==过滤器==</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#组件化"><span class="nav-number">1.4.3.7.</span> <span class="nav-text">组件化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#父子组件传值"><span class="nav-number">1.4.3.8.</span> <span class="nav-text">==父子组件传值==</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#使用了-emit向父组件中返回值"><span class="nav-number">1.4.3.8.1.</span> <span class="nav-text">==使用了$emit向父组件中返回值==</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#父组件可以使用-props-把数据传给子组件"><span class="nav-number">1.4.3.8.2.</span> <span class="nav-text">==父组件可以使用 props 把数据传给子组件==</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#生命周期钩子函数"><span class="nav-number">1.4.3.9.</span> <span class="nav-text">生命周期钩子函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用脚手架快速开发"><span class="nav-number">1.4.3.10.</span> <span class="nav-text">使用脚手架快速开发</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Babel"><span class="nav-number">1.4.4.</span> <span class="nav-text">Babel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Webpack"><span class="nav-number">1.4.5.</span> <span class="nav-text">Webpack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringCloud-amp-SpringCloud-Alibaba组件"><span class="nav-number">1.5.</span> <span class="nav-text">==SpringCloud &amp; SpringCloud Alibaba组件==</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringCloud-Alibaba-Nacos：注册中心（服务发现注册）"><span class="nav-number">1.5.0.1.</span> <span class="nav-text">SpringCloud Alibaba - Nacos：注册中心（服务发现注册）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringCloud-Alibaba-Nacos：配置中心-（动态配置管理）"><span class="nav-number">1.5.0.2.</span> <span class="nav-text">==SpringCloud Alibaba - Nacos：配置中心==（动态配置管理）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#基础"><span class="nav-number">1.5.0.2.1.</span> <span class="nav-text">基础</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#进阶"><span class="nav-number">1.5.0.2.2.</span> <span class="nav-text">进阶</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringCloud-Ribbon：负载均衡"><span class="nav-number">1.5.0.3.</span> <span class="nav-text">SpringCloud - Ribbon：负载均衡</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringCloud-Feign：声明式-HTTP-客户端（调用远程服务）"><span class="nav-number">1.5.0.4.</span> <span class="nav-text">SpringCloud - Feign：声明式 HTTP 客户端（调用远程服务）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringCloud-Alibaba-Sentinel：服务容错（限流、降级、熔断）"><span class="nav-number">1.5.0.5.</span> <span class="nav-text">SpringCloud Alibaba - Sentinel：服务容错（限流、降级、熔断）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringCloud-Gateway：API-网关（webflux-编程模式）"><span class="nav-number">1.5.0.6.</span> <span class="nav-text">SpringCloud - Gateway：API 网关（webflux 编程模式）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringCloud-Sleuth：调用链监控"><span class="nav-number">1.5.0.7.</span> <span class="nav-text">SpringCloud - Sleuth：调用链监控</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringCloud-Alibaba-Seata：原Fescar，即分布式事务解决方案"><span class="nav-number">1.5.0.8.</span> <span class="nav-text">SpringCloud Alibaba - Seata：原Fescar，即分布式事务解决方案</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringCloud-Alibaba-OSS"><span class="nav-number">1.5.0.9.</span> <span class="nav-text">SpringCloud Alibaba - OSS</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#后端正式开发"><span class="nav-number">1.6.</span> <span class="nav-text">后端正式开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-构建权限树"><span class="nav-number">1.6.1.</span> <span class="nav-text">1.构建权限树</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-gateway配置路由-作用-前端项目不用再一个一个改请求地址"><span class="nav-number">1.6.2.</span> <span class="nav-text">2.gateway配置路由(作用:前端项目不用再一个一个改请求地址)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-跨域-amp-CORS同源策略"><span class="nav-number">1.6.3.</span> <span class="nav-text">==3.跨域&amp;CORS同源策略==</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-对象存储"><span class="nav-number">1.6.4.</span> <span class="nav-text">==4.对象存储==</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-校验配置"><span class="nav-number">1.6.5.</span> <span class="nav-text">5.校验配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#5-1-可以紧跟-Valid后的bean声明BindingResult获得校验结果"><span class="nav-number">1.6.5.1.</span> <span class="nav-text">5.1 可以紧跟@Valid后的bean声明BindingResult获得校验结果</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-2-分组校验"><span class="nav-number">1.6.5.2.</span> <span class="nav-text">5.2 分组校验</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-3-自定义校验"><span class="nav-number">1.6.5.3.</span> <span class="nav-text">5.3 自定义校验</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-日志"><span class="nav-number">1.6.6.</span> <span class="nav-text">6.日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-推荐不要使用关联查询，把sql语句拆成多句"><span class="nav-number">1.6.7.</span> <span class="nav-text">7.推荐不要使用关联查询，把sql语句拆成多句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-for和foreach的区别"><span class="nav-number">1.6.8.</span> <span class="nav-text">8.for和foreach的区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-feign细节"><span class="nav-number">1.6.9.</span> <span class="nav-text">==9.feign细节==</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-SPU和SKU"><span class="nav-number">1.6.10.</span> <span class="nav-text">10.SPU和SKU</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前端项目开发"><span class="nav-number">1.7.</span> <span class="nav-text">前端项目开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-index-js中配置请求路径"><span class="nav-number">1.7.1.</span> <span class="nav-text">1.index.js中配置请求路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-data-解构数据"><span class="nav-number">1.7.2.</span> <span class="nav-text">2.{data}解构数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-飘号-引用变量"><span class="nav-number">1.7.3.</span> <span class="nav-text">3.``(飘号)引用变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-拖拽功能有空可以看看"><span class="nav-number">1.7.4.</span> <span class="nav-text">4.拖拽功能有空可以看看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-this-refs-menuTree"><span class="nav-number">1.7.5.</span> <span class="nav-text">==5.this.$refs.menuTree==</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-slot"><span class="nav-number">1.7.6.</span> <span class="nav-text">==6.slot==</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-上传文件"><span class="nav-number">1.7.7.</span> <span class="nav-text">==7.上传文件==</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-父子组件传值"><span class="nav-number">1.7.8.</span> <span class="nav-text">8.父子组件传值</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#8-1-使用了-emit向父组件中返回值"><span class="nav-number">1.7.8.1.</span> <span class="nav-text">==8.1 使用了$emit向父组件中返回值==</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-2-父组件可以使用-props-把数据传给子组件"><span class="nav-number">1.7.8.2.</span> <span class="nav-text">8.2 父组件可以使用 props 把数据传给子组件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-表单校验"><span class="nav-number">1.7.9.</span> <span class="nav-text">9.表单校验</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题"><span class="nav-number">1.8.</span> <span class="nav-text">问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-什么是微服务？"><span class="nav-number">1.8.1.</span> <span class="nav-text">1.什么是微服务？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-分布式和集群的区别？"><span class="nav-number">1.8.2.</span> <span class="nav-text">2.分布式和集群的区别？</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bug"><span class="nav-number">1.9.</span> <span class="nav-text">Bug</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-nacos-报错endpoint-is-blank"><span class="nav-number">1.9.1.</span> <span class="nav-text">1.nacos 报错endpoint is blank</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高级篇"><span class="nav-number">2.</span> <span class="nav-text">高级篇</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#要点"><span class="nav-number">2.1.</span> <span class="nav-text">==要点==</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-项目中使用elasticsearch"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.项目中使用elasticsearch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-使用typeReference封装接口"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.使用typeReference封装接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-测试分布式场景"><span class="nav-number">2.1.3.</span> <span class="nav-text">3.测试分布式场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-注意线程池配置"><span class="nav-number">2.1.4.</span> <span class="nav-text">4.注意线程池配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-feign远程请求丢失请求头"><span class="nav-number">2.1.5.</span> <span class="nav-text">5.feign远程请求丢失请求头</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-feign异步调用丢失上下文信息"><span class="nav-number">2.1.6.</span> <span class="nav-text">6.feign异步调用丢失上下文信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-幂等性"><span class="nav-number">2.1.7.</span> <span class="nav-text">==7.幂等性==</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#概念"><span class="nav-number">2.1.7.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#场景"><span class="nav-number">2.1.7.2.</span> <span class="nav-text">场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#解决方案"><span class="nav-number">2.1.7.3.</span> <span class="nav-text">解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-token机制"><span class="nav-number">2.1.7.3.1.</span> <span class="nav-text">1.token机制</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-锁机制"><span class="nav-number">2.1.7.3.2.</span> <span class="nav-text">2.锁机制</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-各种唯一约束"><span class="nav-number">2.1.7.3.3.</span> <span class="nav-text">3.各种唯一约束</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-防重表"><span class="nav-number">2.1.7.3.4.</span> <span class="nav-text">4.防重表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-全局请求唯一id"><span class="nav-number">2.1.7.3.5.</span> <span class="nav-text">5.全局请求唯一id</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ElasticSearch"><span class="nav-number">2.2.</span> <span class="nav-text">ElasticSearch</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本概念"><span class="nav-number">2.2.1.</span> <span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-index-索引-，"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">1.index(索引)，</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-type-类型-，类似于mysql的table"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">2.type(类型)，类似于mysql的table</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-Document-文档-，相当于mysql表中的数据-行"><span class="nav-number">2.2.1.3.</span> <span class="nav-text">3.Document(文档)，相当于mysql表中的数据(行)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-倒排索引"><span class="nav-number">2.2.1.4.</span> <span class="nav-text">==4.倒排索引==</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装"><span class="nav-number">2.2.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高级检索"><span class="nav-number">2.2.3.</span> <span class="nav-text">高级检索</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-SearchAPI"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">1.SearchAPI</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-Query-DSL"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">2.Query DSL</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-Mapping"><span class="nav-number">2.2.3.3.</span> <span class="nav-text">3.Mapping</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-分词"><span class="nav-number">2.2.3.4.</span> <span class="nav-text">4.分词</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringBoot整合"><span class="nav-number">2.2.4.</span> <span class="nav-text">SpringBoot整合</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#导入依赖"><span class="nav-number">2.2.4.1.</span> <span class="nav-text">导入依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#配置类"><span class="nav-number">2.2.4.2.</span> <span class="nav-text">配置类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DSL在java中的示例"><span class="nav-number">2.2.4.3.</span> <span class="nav-text">==DSL在java中的示例==</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bug"><span class="nav-number">2.2.5.</span> <span class="nav-text">bug</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx"><span class="nav-number">2.3.</span> <span class="nav-text">==nginx==</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-1"><span class="nav-number">2.3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置文件"><span class="nav-number">2.3.2.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用nginx反向代理"><span class="nav-number">2.3.3.</span> <span class="nav-text">==使用nginx反向代理==</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#原理"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#不改进"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">不改进</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#改进"><span class="nav-number">2.3.3.3.</span> <span class="nav-text">改进</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用nginx实现动静分离"><span class="nav-number">2.3.4.</span> <span class="nav-text">==使用nginx实现动静分离==</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#压力测试"><span class="nav-number">2.4.</span> <span class="nav-text">压力测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#性能指标"><span class="nav-number">2.4.1.</span> <span class="nav-text">性能指标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Jemter工具"><span class="nav-number">2.4.2.</span> <span class="nav-text">Jemter工具</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#bug-1"><span class="nav-number">2.4.2.1.</span> <span class="nav-text">bug</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#性能监控"><span class="nav-number">2.5.</span> <span class="nav-text">性能监控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#jvisualvm"><span class="nav-number">2.5.1.</span> <span class="nav-text">jvisualvm</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存与分布式锁-Redis"><span class="nav-number">2.6.</span> <span class="nav-text">==缓存与分布式锁(Redis)==</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装与启动"><span class="nav-number">2.6.1.</span> <span class="nav-text">安装与启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringBoot整合-1"><span class="nav-number">2.6.2.</span> <span class="nav-text">SpringBoot整合</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#本地锁"><span class="nav-number">2.6.3.</span> <span class="nav-text">本地锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分布式锁"><span class="nav-number">2.6.4.</span> <span class="nav-text">分布式锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用Redisson实现分布式锁"><span class="nav-number">2.6.5.</span> <span class="nav-text">使用Redisson实现分布式锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#阻塞锁Rlock测试"><span class="nav-number">2.6.5.1.</span> <span class="nav-text">阻塞锁Rlock测试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#读写锁RReadWriteLock测试"><span class="nav-number">2.6.5.2.</span> <span class="nav-text">读写锁RReadWriteLock测试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#信号量Semaphore测试"><span class="nav-number">2.6.5.3.</span> <span class="nav-text">信号量Semaphore测试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#闭锁CountDownLatch测试"><span class="nav-number">2.6.5.4.</span> <span class="nav-text">闭锁CountDownLatch测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存数据库一致性问题"><span class="nav-number">2.6.6.</span> <span class="nav-text">缓存数据库一致性问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#双写模式"><span class="nav-number">2.6.6.1.</span> <span class="nav-text">双写模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#失效模式"><span class="nav-number">2.6.6.2.</span> <span class="nav-text">失效模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#都会有脏数据问题-解决方案"><span class="nav-number">2.6.6.3.</span> <span class="nav-text">都会有脏数据问题(解决方案)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringCache"><span class="nav-number">2.7.</span> <span class="nav-text">SpringCache</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#介绍"><span class="nav-number">2.7.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置"><span class="nav-number">2.7.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#常用注解"><span class="nav-number">2.7.3.</span> <span class="nav-text">常用注解</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Cacheable"><span class="nav-number">2.7.3.1.</span> <span class="nav-text">@Cacheable</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CacheEvict"><span class="nav-number">2.7.3.2.</span> <span class="nav-text">@CacheEvict</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CachePut"><span class="nav-number">2.7.3.3.</span> <span class="nav-text">@CachePut</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Caching"><span class="nav-number">2.7.3.4.</span> <span class="nav-text">@Caching</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#不足"><span class="nav-number">2.7.4.</span> <span class="nav-text">不足</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#读模式"><span class="nav-number">2.7.4.1.</span> <span class="nav-text">读模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#写模式-缓存数据库不一致"><span class="nav-number">2.7.4.2.</span> <span class="nav-text">写模式(缓存数据库不一致)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步"><span class="nav-number">2.8.</span> <span class="nav-text">==异步==</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CompletableFuture异步编排"><span class="nav-number">2.8.1.</span> <span class="nav-text">CompletableFuture异步编排</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#初步使用-1"><span class="nav-number">2.8.1.1.</span> <span class="nav-text">初步使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#回调方法"><span class="nav-number">2.8.1.2.</span> <span class="nav-text">回调方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#handle"><span class="nav-number">2.8.1.3.</span> <span class="nav-text">handle()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#串行化"><span class="nav-number">2.8.1.4.</span> <span class="nav-text">串行化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#两个任务都要完成"><span class="nav-number">2.8.1.5.</span> <span class="nav-text">两个任务都要完成</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#两个任务只要一个完成"><span class="nav-number">2.8.1.6.</span> <span class="nav-text">两个任务只要一个完成</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#多任务组合"><span class="nav-number">2.8.1.7.</span> <span class="nav-text">多任务组合</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实战"><span class="nav-number">2.8.2.</span> <span class="nav-text">实战</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#认证服务"><span class="nav-number">2.9.</span> <span class="nav-text">认证服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简单登录逻辑"><span class="nav-number">2.9.1.</span> <span class="nav-text">简单登录逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#验证码-令牌机制"><span class="nav-number">2.9.1.1.</span> <span class="nav-text">验证码(令牌机制)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#注册"><span class="nav-number">2.9.1.2.</span> <span class="nav-text">注册</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#社交登录"><span class="nav-number">2.9.2.</span> <span class="nav-text">社交登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分布式Session"><span class="nav-number">2.9.3.</span> <span class="nav-text">==分布式Session==</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#方案1-session复制"><span class="nav-number">2.9.3.1.</span> <span class="nav-text">方案1-session复制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#方案2-客户端存储"><span class="nav-number">2.9.3.2.</span> <span class="nav-text">方案2-客户端存储</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#方案3-使用hash一致性"><span class="nav-number">2.9.3.3.</span> <span class="nav-text">方案3-使用hash一致性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#方案4-统一存储"><span class="nav-number">2.9.3.4.</span> <span class="nav-text">方案4-统一存储</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用SpringSession的最终方案"><span class="nav-number">2.9.3.5.</span> <span class="nav-text">==使用SpringSession的最终方案==</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#原理图"><span class="nav-number">2.9.3.5.1.</span> <span class="nav-text">原理图</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#导入依赖-1"><span class="nav-number">2.9.3.5.2.</span> <span class="nav-text">导入依赖</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#yml配置"><span class="nav-number">2.9.3.5.3.</span> <span class="nav-text">yml配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#配置类的注解"><span class="nav-number">2.9.3.5.4.</span> <span class="nav-text">配置类的注解</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#存入redis"><span class="nav-number">2.9.3.5.5.</span> <span class="nav-text">==存入redis==</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#实现子域session共享的问题"><span class="nav-number">2.9.3.5.6.</span> <span class="nav-text">==实现子域session共享的问题==</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#SpringSession核心原理"><span class="nav-number">2.9.3.5.7.</span> <span class="nav-text">==SpringSession核心原理==</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单点登录"><span class="nav-number">2.9.4.</span> <span class="nav-text">单点登录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#购物车功能"><span class="nav-number">2.10.</span> <span class="nav-text">购物车功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数据结构"><span class="nav-number">2.10.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#业务需求"><span class="nav-number">2.10.2.</span> <span class="nav-text">==业务需求==</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#购物车redis代码"><span class="nav-number">2.10.3.</span> <span class="nav-text">购物车redis代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ"><span class="nav-number">2.11.</span> <span class="nav-text">RabbitMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-2"><span class="nav-number">2.11.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MQ优势"><span class="nav-number">2.11.2.</span> <span class="nav-text">MQ优势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息队列两大规范"><span class="nav-number">2.11.3.</span> <span class="nav-text">消息队列两大规范</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基本组件图-概念图"><span class="nav-number">2.11.4.</span> <span class="nav-text">基本组件图(概念图)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringBoot整合-2"><span class="nav-number">2.11.5.</span> <span class="nav-text">SpringBoot整合</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#导入依赖-2"><span class="nav-number">2.11.5.1.</span> <span class="nav-text">导入依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AmqpAdmin用于增删改查队列、交换机及其绑定关系等"><span class="nav-number">2.11.5.2.</span> <span class="nav-text">AmqpAdmin用于增删改查队列、交换机及其绑定关系等</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RabbitTemplate用于发送消息"><span class="nav-number">2.11.5.3.</span> <span class="nav-text">RabbitTemplate用于发送消息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RabbitListner用于监听信息"><span class="nav-number">2.11.5.4.</span> <span class="nav-text">@RabbitListner用于监听信息</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息确认机制"><span class="nav-number">2.11.6.</span> <span class="nav-text">消息确认机制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfirmCallback"><span class="nav-number">2.11.6.1.</span> <span class="nav-text">ConfirmCallback</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ReturnCallback"><span class="nav-number">2.11.6.2.</span> <span class="nav-text">ReturnCallback</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Ack消息确认机制"><span class="nav-number">2.11.6.3.</span> <span class="nav-text">==Ack消息确认机制==</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#代码实现"><span class="nav-number">2.11.6.4.</span> <span class="nav-text">代码实现</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#延时队列"><span class="nav-number">2.11.7.</span> <span class="nav-text">延时队列</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#死信路由-DLX"><span class="nav-number">2.11.7.1.</span> <span class="nav-text">死信路由(DLX)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#场景-1"><span class="nav-number">2.11.7.2.</span> <span class="nav-text">场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#定时任务时效性"><span class="nav-number">2.11.7.3.</span> <span class="nav-text">定时任务时效性</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#订单业务—使用MQ实现最终一致性的分布式事务"><span class="nav-number">2.11.8.</span> <span class="nav-text">==订单业务—使用MQ实现最终一致性的分布式事务==</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#整体消息队列架构"><span class="nav-number">2.11.8.1.</span> <span class="nav-text">整体消息队列架构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建延时队列"><span class="nav-number">2.11.8.2.</span> <span class="nav-text">创建延时队列</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建死信交换机"><span class="nav-number">2.11.8.3.</span> <span class="nav-text">创建死信交换机</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建目的地交换机"><span class="nav-number">2.11.8.4.</span> <span class="nav-text">创建目的地交换机</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#绑定关系"><span class="nav-number">2.11.8.5.</span> <span class="nav-text">绑定关系</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#发消息"><span class="nav-number">2.11.8.6.</span> <span class="nav-text">发消息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#监听过期消息"><span class="nav-number">2.11.8.7.</span> <span class="nav-text">监听过期消息</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MQ的几个可靠性问题"><span class="nav-number">2.11.9.</span> <span class="nav-text">MQ的几个可靠性问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#消息丢失"><span class="nav-number">2.11.9.1.</span> <span class="nav-text">消息丢失</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#消息重复"><span class="nav-number">2.11.9.2.</span> <span class="nav-text">消息重复</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#消息积压"><span class="nav-number">2.11.9.3.</span> <span class="nav-text">消息积压</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#订单业务"><span class="nav-number">2.12.</span> <span class="nav-text">==订单业务==</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#幂等性"><span class="nav-number">2.12.1.</span> <span class="nav-text">==幂等性==</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分布式事务"><span class="nav-number">2.12.2.</span> <span class="nav-text">==分布式事务==</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#seata（2PC）"><span class="nav-number">2.12.2.1.</span> <span class="nav-text">seata（2PC）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#使用步骤"><span class="nav-number">2.12.2.1.1.</span> <span class="nav-text">使用步骤</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#模式"><span class="nav-number">2.12.2.1.2.</span> <span class="nav-text">模式</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#高性能的实现方式"><span class="nav-number">2.12.2.2.</span> <span class="nav-text">==高性能的实现方式==</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#业务分析"><span class="nav-number">2.12.3.</span> <span class="nav-text">业务分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式原理"><span class="nav-number">2.13.</span> <span class="nav-text">==分布式原理==</span></a></li></ol></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/alex-next/images/avatar.jpg"
      alt="alex">
  <p class="site-author-name" itemprop="name">alex</p>
  <div class="site-description" itemprop="description">时光静好,与君语;细水流年,与君同;繁华落尽,与君老.</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/alex-next/archives/">
        
          <span class="site-state-item-count">46</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/alex-next/categories/">
          
        
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/alex-next/tags/">
          
        
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/alex-next/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">alex</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.0</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/alex-next/lib/anime.min.js?v=3.1.0"></script>
  <script src="/alex-next/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/alex-next/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  <script src="/alex-next/lib/pjax/pjax.min.js?v=0.2.8"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
<script src="/alex-next/js/utils.js?v=7.4.0"></script><script src="/alex-next/js/motion.js?v=7.4.0"></script>
<script src="/alex-next/js/schemes/pisces.js?v=7.4.0"></script>
<script src="/alex-next/js/next-boot.js?v=7.4.0"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[pjax], script#page-configurations, #pjax script').forEach(element => {
    var id = element.id || '';
    var src = element.src || '';
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (id !=='') {
      script.id = element.id;
    }
    if (src !== '') {
      script.src = src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  








  <script src="/alex-next/js/local-search.js?v=7.4.0"></script>













    <div id="pjax">

  

  
    
      
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    
  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '84888b5ba3be0f56b2ed',
      clientSecret: '1306406ecbdc02b679df3c95b94985753d302d6a',
      repo: 'alex-next',
      owner: 'alexander-wd',
      admin: ['alexander-wd'],
      id: 'db0c50998d0d6ae2e3f70b869ef7bc36',
        language: 'zh-CN',
      
      distractionFreeMode: 'true'
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
</script>

    </div>
</body>
</html>
